"use strict";(self.webpackChunkRevenUWebApp=self.webpackChunkRevenUWebApp||[]).push([[1727],{21727:(L,O,P)=>{P.r(O),P.d(O,{INV_Ageing:()=>b});var w=P(9659),d=P(66148),v=P(3955),y=P(76962),B=P(53879),m=P(39107),N=P(76428),E=P(47719),A=P(11403);class b extends B.A{constructor(t){super(t),this.k=0,this.drMain=null,this.colSlabIndex=-1,this.colSpanBF=-1,this.colSubTotalStartIndex=0,this.colQOHIndex=-1,this.colMonthIndex=-1,this.CntMonths=0,this.Slabs=new Array,this.iSlabs=new Array,this.dblQty=0,this.dblValue=0,this.dblAvgRate=0,this.exchRate=0,this.ShowLevelTree=!1,this.IsConsolidated=!1,this.BatchConsolidated=!1,this.ShowYearWise=!1,this.ShowMonthWise=!1,this.LevelNo=0,this.DefValuation=0,this.ForeignCurrencyID=0,this.CurrencyType=0,this.ViewCurrencyID=1,this.strProductID=null,this.AgeingDimWhere="",this.SortTransactionsBy="",this.SlabQty=null,this.SlabValue=null,this.SlabPercent=null,this.MonthFromDate=null,this.FilterData="",this.HideBinQty=!1,this.IsBinDetail=!1,this.iLoop=0,this.lstPCRates=new Array,this.TagID=0,this.IsPCodeLink=!1,this.IsPNameLink=!1,this.ShowDetailReport=!1,this.TempRTVisible=!1,this.strExcludeStockTransfer="",this.lstTotal=null,this.lstParents=new Array,this.dbl=0,this.dblS0=0,this.dblS1=0,this.dblS2=0,this.dblS3=0,this.dblS4=0,this.dblIssue=0,this.dtProducts=null}LoadReport(){if(this.GrdRow=-1,this.colSubTotalStartIndex=-1,this.AggTotal=d.J0.NumArray(this.oColumns.length,2),this.lstTotal=new Array,this.ViewModel.Preferences.ContainsKey("Slabs")){let e=new d.VB;e.LoadXml("<XML>"+this.ViewModel.Preferences.Slabs+"</XML>"),this.Slabs.Clear(),this.iSlabs.Clear(),e.DocumentElement.childNodes.forEach(s=>{this.iSlabs.push(parseInt(s.innerHTML)),this.Slabs.push(this.ViewModel.oReportDialog.ToDate.Date.AddDays(this.iSlabs[this.iSlabs.length-1]))})}for(let e=0;e<this.ViewModel.ColumnSource.length;e++)if("FLOAT"==this.ViewModel.ColumnSource[e].ColumnType){this.colSpanBF=e;break}if(this.ViewModel.lstGroup.length>0)for(this.k=0;this.k<this.ViewModel.ColumnSource.length;this.k++)if(this.ViewModel.lstGroup[0].TotalCols.ContainsKey(this.ViewModel.ColumnSource[this.k].ID)){this.colSubTotalStartIndex=this.k;break}for(let e=this.ViewModel.ColumnSource.length-1;e>=0;e--)"Expired"==this.ViewModel.ColumnSource[e].ID||"Balance"==this.ViewModel.ColumnSource[e].ID?this.colSlabIndex=e:"QOH"==this.ViewModel.ColumnSource[e].ID&&(this.colQOHIndex=e);this.FilterData=this.ViewModel.Preferences.ContainsKey("Filter")?this.ViewModel.Preferences.Filter:"";let t=new Array;for(let e=0;e<this.ViewModel.ColumnSource.length;e++)t.push(this.ViewModel.ColumnSource[e]);if(82==this.ViewModel.StaticReportType){if(this.ViewModel.Preferences.ContainsKey("MonthWiseMonths")){let e=new d.VB;e.LoadXml("<XML>"+this.ViewModel.Preferences.MonthWiseMonths+"</XML>");let s=d.VB.SelectSingleNode(e.DocumentElement,"IsChecked");if(null!=s&&"1"==s.innerHTML&&(this.ShowMonthWise=!0,s=d.VB.SelectSingleNode(e.DocumentElement,"Text"),this.CntMonths=d.J0.Int(s.innerHTML),this.CntMonths<=0&&(this.ShowMonthWise=!1),this.ShowMonthWise)){this.iSlabs.Clear(),this.Slabs.Clear();let i=this.ViewModel.oReportDialog.ToDate.Date;for(let o=0;o<this.CntMonths;o++)this.iSlabs.push(1),i=new Date(i.getFullYear(),i.getMonth(),1).AddMonths(1).AddDays(-1),this.Slabs.push(i),i=i.AddDays(1)}}}else if(83==this.ViewModel.StaticReportType)this.SlabPercent=t.find(e=>"SlabPercent"==e.ID),this.SlabPercent&&t.Remove(this.SlabPercent);else if(84==this.ViewModel.StaticReportType){if(this.ViewModel.Preferences.ContainsKey("ShowYearWise")){let e=new d.VB;e.LoadXml("<XML>"+this.ViewModel.Preferences.ShowYearWise+"</XML>");let s=d.VB.SelectSingleNode(e.DocumentElement,"IsChecked");if(null!=s&&"1"==s.innerHTML&&(this.ShowYearWise=!0,s=d.VB.SelectSingleNode(e.DocumentElement,"Text"),this.CntMonths=d.J0.Int(s.innerHTML),this.CntMonths<=0&&(this.ShowYearWise=!1),this.ShowYearWise)){this.iSlabs.Clear(),this.Slabs.Clear();let i=new Date((new Date).getFullYear(),w.d.SessionManager.AccountingFromMonth-1,1);i>Date.Today()&&(i=i.AddYears(-1));for(let o=0;o<this.CntMonths;o++)this.iSlabs.push(1),this.Slabs.push(i),i=i.AddYears(-1)}}for(let e=t.length-1;e>=0;e--)"SlabQty"==t[e].ID?(this.SlabQty=t[e],t.RemoveAt(e),this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("SlabQty")&&this.ViewModel.GrpReportTotal.TotalCols.Remove("SlabQty"),this.ViewModel.lstGroup.length>0&&this.ViewModel.lstGroup[0].TotalCols.ContainsKey("SlabQty")&&this.ViewModel.lstGroup[0].TotalCols.Remove("SlabQty")):"SlabValue"==t[e].ID&&(this.SlabValue=t[e],t.RemoveAt(e),this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("SlabValue")&&this.ViewModel.GrpReportTotal.TotalCols.Remove("SlabValue"),this.ViewModel.lstGroup.length>0&&this.ViewModel.lstGroup[0].TotalCols.ContainsKey("SlabValue")&&this.ViewModel.lstGroup[0].TotalCols.Remove("SlabValue"))}if(null==this.SlabQty&&null==this.SlabValue){for(let e=this.ViewModel.ColumnSource.length-1;e>=0;e--){if("BalQty"==this.ViewModel.ColumnSource[e].ID){this.SlabQty=this.ViewModel.ColumnSource[e];break}if(83==this.ViewModel.StaticReportType&&"Quantity"==this.ViewModel.ColumnSource[e].ID){this.SlabQty=this.ViewModel.ColumnSource[e];break}if("Months"==this.ViewModel.ColumnSource[e].ID){this.colMonthIndex=e;break}}null==this.SlabQty&&(this.SlabQty=this.ViewModel.ColumnSource[this.ViewModel.ColumnSource.length-1])}if(82==this.ViewModel.StaticReportType)for(let e=0;e<30&&this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("S"+e);e++)this.ViewModel.GrpReportTotal.TotalCols.Remove("S"+e),this.ViewModel.lstGroup.forEach(s=>{s.TotalCols.ContainsKey("S"+e)&&s.TotalCols.Remove("S"+e)});if(this.Slabs.length>0)for(let e=0,s=this.Slabs.length;e<=this.Slabs.length;e++,s--)if(84==this.ViewModel.StaticReportType){let i,o;null!=this.SlabQty&&(o=this.SlabQty.Clone(),this.ShowYearWise?(o.ID="S"+s,o.HeaderText=s==this.Slabs.length?"< "+this.Slabs[s-1].ToString("MMM yyyy"):1==this.Slabs[s].iMonth()?this.Slabs[s].ToString("yyyy"):this.Slabs[s].ToString("yyyy")+"-"+this.Slabs[s].AddYears(1).ToString("yy")):(o.ID="S"+e,o.HeaderText=0==e?"1-"+this.iSlabs[e]:e==this.Slabs.length?">"+this.iSlabs[this.iSlabs.length-1]:this.iSlabs[e-1]+1+"-"+this.iSlabs[e]),this.ShowYearWise||(e<this.iSlabs.length&&0==this.iSlabs[e]||e==this.iSlabs.length&&0==this.iSlabs[this.iSlabs.length-1])&&(o.HeaderAppearance.IsVisible=!1),t.push(o),this.ViewModel.IsTotalColsAdded||(this.ViewModel.lstGroup.forEach(h=>{h.TotalCols.push(o.ID,t.length-1)}),this.ViewModel.GrpReportTotal.TotalCols.push(o.ID,t.length-1))),null!=this.SlabValue&&(i=this.SlabValue.Clone(),null==this.SlabQty?this.ShowYearWise?(i.ID="SV"+s,i.HeaderText=s==this.Slabs.length?"< "+this.Slabs[s-1].ToString("MMM yyyy"):1==this.Slabs[s].iMonth()?this.Slabs[s].ToString("yyyy"):this.Slabs[s].ToString("yyyy")+"-"+this.Slabs[s].AddYears(1).ToString("yy")):(i.ID="SV"+e,i.HeaderText=0==e?"1-"+this.iSlabs[e]+" Value":e==this.Slabs.length?">"+this.iSlabs[this.iSlabs.length-1]+" Value":this.iSlabs[e-1]+1+"-"+this.iSlabs[e]+" Value"):(i.ID=this.ShowYearWise?"SV"+s:"SV"+e,i.HeaderText="Value"),this.ShowYearWise||(e<this.iSlabs.length&&0==this.iSlabs[e]||e==this.iSlabs.length&&0==this.iSlabs[this.iSlabs.length-1])&&(i.HeaderAppearance.IsVisible=!1),t.push(i),this.ViewModel.IsTotalColsAdded||(this.ViewModel.lstGroup.forEach(h=>{h.TotalCols.push(i.ID,t.length-1)}),this.ViewModel.GrpReportTotal.TotalCols.push(i.ID,t.length-1)))}else if(82==this.ViewModel.StaticReportType){let i=this.ViewModel.ColumnSource.find(o=>"Quantity"==o.ID);i||(i=this.ViewModel.ColumnSource.find(o=>"Expired"==o.ID)),i||(i=this.ViewModel.ColumnSource[this.ViewModel.ColumnSource.length-1]),i=i.Clone(),i.DataAppearance.IsVisible=!0,i.ID="S"+e,i.HeaderText=this.ShowMonthWise?e==this.Slabs.length?">"+this.Slabs[e-1].ToString("MMM yyyy"):this.Slabs[e].ToString("MMM yyyy"):0==e?"1-"+this.iSlabs[e]:e==this.Slabs.length?">"+this.iSlabs[this.iSlabs.length-1]:this.iSlabs[e-1]+1+"-"+this.iSlabs[e],("Expired"==this.FilterData||e<this.iSlabs.length&&0==this.iSlabs[e]||e==this.iSlabs.length&&(0==this.iSlabs[this.iSlabs.length-1]||"SelectedSlabActive"==this.FilterData))&&(i.HeaderAppearance.IsVisible=!1),t.Insert(this.colSlabIndex+e+1,i),this.ViewModel.GrpReportTotal.TotalCols.push(i.ID,this.colSlabIndex+e+1),this.ViewModel.GrpReportTotal.TotalCols.Slab=t.length-1,this.ViewModel.lstGroup.forEach(o=>{o.TotalCols.push(i.ID,this.colSlabIndex+e+1),o.TotalCols.Slab=t.length-1})}else{let i=null!=this.SlabQty?this.SlabQty.Clone():this.ViewModel.ColumnSource[this.ViewModel.ColumnSource.length-1].Clone();i.ID="S"+e,i.HeaderText=0==e?"1-"+this.iSlabs[e]:e==this.Slabs.length?">"+this.iSlabs[this.iSlabs.length-1]:this.iSlabs[e-1]+1+"-"+this.iSlabs[e],(e<this.iSlabs.length&&0==this.iSlabs[e]||e==this.iSlabs.length&&0==this.iSlabs[this.iSlabs.length-1])&&(i.HeaderAppearance.IsVisible=!1);let o=this.colSlabIndex+e+1;if(null!=this.SlabPercent&&(o=this.colSlabIndex+2*e+1),t.Insert(o,i),this.ViewModel.IsTotalColsAdded||(this.ViewModel.GrpReportTotal.TotalCols.push(i.ID,o),this.ViewModel.GrpReportTotal.TotalCols.Slab=t.length-1,this.ViewModel.lstGroup.forEach(h=>{h.TotalCols.push(i.ID,o),h.TotalCols.Slab=t.length-1})),null!=this.SlabPercent){let h=this.SlabPercent.Clone();h.ID="P"+e,h.HeaderText="%",h.HeaderAppearance.IsVisible=i.HeaderAppearance.IsVisible,o++,t.Insert(o,h)}}if(82==this.ViewModel.StaticReportType&&this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("Slab")&&(this.ViewModel.GrpReportTotal.TotalCols.Remove("Slab"),this.ViewModel.lstGroup.forEach(e=>{e.TotalCols.Remove("Slab")})),(114==this.ViewModel.StaticReportType||115==this.ViewModel.StaticReportType)&&(this.CntMonths=0,-1!=this.colMonthIndex)){this.ViewModel.TotalCols.Clear(),this.ViewModel.GrpReportTotal.TotalCols.Clear(),(114==this.ViewModel.StaticReportType||115==this.ViewModel.StaticReportType)&&(this.ViewModel.AddTotalColumnsToGroup(this.ViewModel.GrpReportTotal,this.ViewModel.ReportDoc.SelectSingleNode("PactRevenURpts/PactRevenURptDef/ReportTotal/Columns")),this.ViewModel.TotalCols.Contains("Months")&&this.ViewModel.TotalCols.Remove("Months"),this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("Months")&&this.ViewModel.GrpReportTotal.TotalCols.Remove("Months"),this.ViewModel.lstGroup.forEach(i=>{i.TotalCols.Clear(),this.ViewModel.AddTotalColumnsToGroup(i,this.ViewModel.ReportDoc.SelectSingleNode("PactRevenURpts/PactRevenURptDef/ReportTotal/Columns")),i.TotalCols.ContainsKey("Months")&&i.TotalCols.Remove("Months")}));let e=new Date(this.ViewModel.FromDatePicker.Date.getFullYear(),this.ViewModel.FromDatePicker.Date.getMonth(),1);if(this.MonthFromDate=e,114==this.ViewModel.StaticReportType){let i=0;if(this.ViewModel.Preferences.ContainsKey("ShowMonths")&&(i=d.J0.Int(this.ViewModel.Preferences.ShowMonths),i>0&&(e=new Date(this.ViewModel.ToDatePicker.Date.getFullYear(),this.ViewModel.ToDatePicker.Date.getMonth(),1),e=e.AddMonths(1-i),e=new Date(e.getFullYear(),e.getMonth(),1),this.MonthFromDate=e)),0==i&&this.ViewModel.DontApplyDateFilter&&this.ViewModel.Preferences.ContainsKey("SalesDocs")&&this.ViewModel.Preferences.SalesDocs.length>0){let o="SELECT convert(datetime,min(DocDate)) FromDate FROM INV_DocDetails A WITH(NOLOCK) \n        WHERE A.CostCenterID IN("+this.ViewModel.Preferences.SalesDocs+") AND DocDate<=CONVERT(INT,CONVERT(DATETIME,'"+this.ViewModel.ToDatePicker.Date.ToString("dd MMM yyyy")+"')) AND A.StatusID<>438",h=w.d.report.ReportDataTable("RPT022",this.ViewModel.IsReportDB,o);null!=h&&h.length>0&&h.Columns.Contains("FromDate")&&(this.MonthFromDate=d.J0.ParseDate(h.Rows[0].FromDate),this.MonthFromDate=new Date(this.MonthFromDate.getFullYear(),this.MonthFromDate.getMonth(),1),this.ViewModel.ToDatePicker.Date.getFullYear()-this.MonthFromDate.getFullYear()>15?this.MonthFromDate=e:e=this.MonthFromDate)}}else 115==this.ViewModel.StaticReportType&&(this.ViewModel.ColumnSource[this.colMonthIndex].HeaderAppearance.IsVisible=!1);let s=this.ViewModel.ToDatePicker.Date;if("DESC"==this.ViewModel.ColumnSource[this.colMonthIndex].DataFormat.Sort)for(;e<=s;){let i=this.ViewModel.ColumnSource[this.colMonthIndex].Clone();i.HeaderAppearance.IsVisible=!0,i.ID="M"+this.CntMonths,i.HeaderText=e.ToString("MMM yyyy"),t.Insert(this.colMonthIndex+1,i),e=e.AddMonths(1),this.ViewModel.TotalCols.push(i.ID),this.ViewModel.GrpReportTotal.TotalCols.push(i.ID,this.colMonthIndex+this.CntMonths),this.ViewModel.lstGroup.forEach(o=>{o.TotalCols.push(i.ID,this.colMonthIndex+this.CntMonths)}),this.CntMonths++}else for(;e<=s;){let i=this.ViewModel.ColumnSource[this.colMonthIndex].Clone();i.HeaderAppearance.IsVisible=!0,i.ID="M"+this.CntMonths,i.HeaderText=e.ToString("MMM yyyy"),t.Insert(this.colMonthIndex+this.CntMonths+1,i),e=e.AddMonths(1),this.ViewModel.TotalCols.push(i.ID),this.ViewModel.GrpReportTotal.TotalCols.push(i.ID,this.colMonthIndex+this.CntMonths),this.ViewModel.lstGroup.forEach(o=>{o.TotalCols.push(i.ID,this.colMonthIndex+this.CntMonths)}),this.CntMonths++}if(this.ViewModel.Preferences.ContainsKey("ShowMonths")){let i;if(i=d.J0.Int(this.ViewModel.Preferences.ShowMonths),i>0){let o=this.ViewModel.ColumnSource[this.colMonthIndex].Clone();o.HeaderAppearance.IsVisible=!0,o.ID="Months",t.Insert(this.colMonthIndex+this.CntMonths+1,o),this.ViewModel.TotalCols.push(o.ID),this.ViewModel.GrpReportTotal.TotalCols.push(o.ID,this.colMonthIndex+this.CntMonths),this.ViewModel.lstGroup.forEach(h=>{h.TotalCols.push(o.ID,this.colMonthIndex+this.CntMonths)}),t.RemoveAt(this.colMonthIndex)}}}this.AggTotal=d.J0.NumArray(t.length,2),this.ViewModel.ReportColumns=t,this.oColumns=this.ViewModel.ReportColumns,this.ViewModel.IsTotalColsAdded=!0,this.ViewModel.totals=d.J0.NumArray(this.oColumns.length,this.ViewModel.lstGroup.length+1);try{if(this.LevelNo=0,this.ShowLevelTree=!1,this.ViewModel.Preferences.ContainsKey("ShowLevel")){let s=new d.VB;s.LoadXml("<XML>"+this.ViewModel.Preferences.ShowLevel+"</XML>");let i=d.VB.SelectSingleNode(s.DocumentElement,"IsChecked");null!=i&&"1"==i.innerHTML&&(this.ShowLevelTree=!0,i=d.VB.SelectSingleNode(s.DocumentElement,"Text"),this.LevelNo=parseInt(i.innerHTML))}let e="";if(this.ChunkSize=this.ViewModel.Preferences.ContainsKey("ChunkSize")?parseInt(this.ViewModel.Preferences.ChunkSize):1,this.DefValuation=0,this.ViewModel.Preferences.ContainsKey("ValuationMethod")&&(this.DefValuation=d.J0.Int(this.ViewModel.Preferences.ValuationMethod)),this.UnPostedDocsInclude=!(!this.ViewModel.Preferences.ContainsKey("IncludeUnPostedDocs")||"1"!=this.ViewModel.Preferences.IncludeUnPostedDocs),this.IsConsolidated=!(!this.ViewModel.Preferences.ContainsKey("ConsolidatedBatches")||"1"!=this.ViewModel.Preferences.ConsolidatedBatches),this.IsBinDetail=!(!this.ViewModel.Preferences.ContainsKey("BinDetail")||"1"!=this.ViewModel.Preferences.BinDetail),this.SortTransactionsBy=this.ViewModel.Preferences.ContainsKey("SortTransactionsBy")?this.ViewModel.Preferences.SortTransactionsBy:"",this.BatchConsolidated=!1,82==this.ViewModel.StaticReportType||83==this.ViewModel.StaticReportType){let s=w.d.report.DataSet("RPT022","SELECT [Value] FROM COM_CostCenterPreferences WITH(NOLOCK) WHERE CostCenterID=16 AND Name='ConsolidatedBatches'");null!=s&&s.Tables[0].length>0&&"TRUE"==s.Tables[0][0].Value.toString().toUpperCase()&&(this.BatchConsolidated=!0)}if(this.CurrencyType=0,this.ForeignCurrencyID=0,this.ViewModel.Preferences.ContainsKey("ForeignCurrency")){let s=new d.VB;s.LoadXml("<XML>"+this.ViewModel.Preferences.ForeignCurrency+"</XML>");let i=d.VB.SelectSingleNode(s.DocumentElement,"IsChecked");null!=i&&"1"==i.innerHTML&&(this.ForeignCurrencyID=parseInt(d.VB.SelectSingleNode(s.DocumentElement,"Value").innerHTML))}else if(this.ViewModel.Preferences.ContainsKey("Currency")){let s=new d.VB;s.LoadXml("<XML>"+this.ViewModel.Preferences.Currency+"</XML>"),this.CurrencyType=parseInt(d.VB.SelectSingleNode(s.DocumentElement,"Type").innerHTML),1==this.CurrencyType?(d.J0.IsEmpty(w.d.SessionManager.Preferences.DimensionwiseCurrency)||0==parseInt(w.d.SessionManager.Preferences.DimensionwiseCurrency))&&(this.CurrencyType=0):2==this.CurrencyType&&(this.ForeignCurrencyID=parseInt(d.VB.SelectSingleNode(s.DocumentElement,"Value").innerHTML))}if(this.exchRate=0,this.ViewModel.Preferences.ContainsKey("FCWithExchRate")){let s=new d.VB;s.LoadXml("<XML>"+this.ViewModel.Preferences.FCWithExchRate+"</XML>");let i=d.VB.SelectSingleNode(s.DocumentElement,"IsChecked");null!=i&&"1"==i.innerHTML&&(i=d.VB.SelectSingleNode(s.DocumentElement,"TextValue"),this.exchRate=d.J0.Double(i.innerHTML),i=d.VB.SelectSingleNode(s.DocumentElement,"ComboValue"),this.ViewCurrencyID=d.J0.Int(i.innerHTML),this.exchRate<=0&&(this.exchRate=1))}e=this.GetQuery(),w.d.report.ReportDataSetAsync("RPT022",this.ViewModel.IsReportDB,e).then(s=>{this.dsMain=s,this.dv=this.dvTable=this.dsMain.Tables[0];var i=this.ViewModel.BaseReportColumns.find(n=>181==n.CDGDO.FieldValue);i&&"2"==i.FormulaEvaluateAtEnd.SelectedValue&&(this.HideBinQty=!0);let o=null!=i?i.ID:null,h=null,r=null,T=null;if(82==this.ViewModel.StaticReportType){let n,l;this.dvIssue=this.dvIssueTable=this.dsMain.Tables[1],this.dvIssueColumns=this.dsMain.Columns[1];for(let u=0;u<this.dsMain.Tables[0].length;u++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);l=this.dsMain.Tables[0][u],this.dblQty=parseFloat(l.Quantity),this.dvIssueColumns.Contains("BinInfo")&&(r=null,h=this.FillBinArrays(l[o].toString()));let M=n;n="BatchID="+l.BatchID.toString(),this.BatchConsolidated||(n+=" AND RefInvDocDetailsID="+this.dv[u].InvDocDetailsID.toString()),this.IsBinDetail&&(n+=" AND BinNodeID="+this.dv[u].BinNodeID.toString()),M!=n&&(this.dvIssue=this.dvIssueTable.filter(f=>f.BatchID==l.BatchID),this.BatchConsolidated||(this.dvIssue=this.dvIssue.filter(f=>f.RefInvDocDetailsID==this.dv[u].InvDocDetailsID)),this.IsBinDetail&&(this.dvIssue=this.dvIssue.filter(f=>f.BinNodeID==this.dv[u].BinNodeID)));for(let f=0;f<this.dvIssue.length;f++){let c=this.dvIssue[f];if(null!=h&&(r=this.FillBinArrays(c.BinInfo.toString()),null!=r))for(let D=0;D<h.length;D++){let a={Key:h.keys[D],Value:h.values[D]};a.Value>0&&r.ContainsKey(a.Key)&&r[a.Key]>0&&(a.Value>r[a.Key]?(h[a.Key]=a.Value-r[a.Key],r[a.Key]=0):(r[a.Key]=r[a.Key]-a.Value,h[a.Key]=0))}if(this.dbl=parseFloat(c.Quantity),this.dblQty=this.dblQty-this.dbl,!(this.dblQty>=0)){l.Quantity=0,c.Quantity=-this.dblQty,this.dblQty=0,null!=r&&(c.BinInfo=this.GetBinInfo(r));break}c.Quantity=0,l.Quantity=this.dblQty,l.Value=this.dblQty*parseFloat(this.dv[u].Rate),null!=r&&(c.BinInfo="")}0!=this.dblQty?null!=h&&(l[o]=this.GetBinInfo(h)):(this.dsMain.Tables[0].RemoveAt(u),u--)}if(this.Slabs.length>0){let u=[];"Expired"==this.FilterData?u=this.dsMain.Tables[0].filter(M=>+M.ExpDate>=+this.ViewModel.oReportDialog.ToDate.Date):"Active"==this.FilterData?u=this.dsMain.Tables[0].filter(M=>+M.ExpDate<this.ViewModel.oReportDialog.ToDate.Date):"SelectedSlabActive"==this.FilterData&&(u=this.dsMain.Tables[0].filter(M=>+M.ExpDate<this.ViewModel.oReportDialog.ToDate.Date||M.ExpDate>this.Slabs[this.Slabs.length-1])),u.forEach(M=>{this.dsMain.Tables[0].Remove(M)})}if(this.IsConsolidated){this.dv.SortBy(["ProductName","BatchNumber"]);let u=0,M=null,f=null,c=null,D=null;for(this.k=this.dv.length-1;this.k>=0;this.k--)M=this.dv[this.k].ProductName.toString(),f=this.dv[this.k].BatchNumber.toString(),M==c&&f==D?(null!=o&&(T=this.FillBinArrays(this.dv[this.k][o].toString()),null!=T&&(null==h&&(h=new v.bT),T.keys.forEach(a=>{let p={Key:a,Value:T[a]};h.ContainsKey(p.Key)?h[p.Key]+=p.Value:h.push(p.Key,p.Value)}),this.dv[this.k+1][o]=this.GetBinInfo(h))),this.dblQty+=parseFloat(this.dv[this.k].Quantity),u+=parseFloat(this.dv[this.k].Quantity)*parseFloat(this.dv[this.k].Rate),this.dv[this.k+1].Quantity=this.dblQty,this.dv[this.k+1].Value=u,this.dv[this.k+1].Rate=u/this.dblQty,this.dvTable.Remove(this.dv[this.k])):(this.dblQty=parseFloat(this.dv[this.k].Quantity),u=parseFloat(this.dv[this.k].Quantity)*parseFloat(this.dv[this.k].Rate),this.dv[this.k].Rate=u/this.dblQty,null!=o&&(h=this.FillBinArrays(this.dv[this.k][o].toString()))),c=M,D=f}(I=this.ViewModel.ColumnSourceALL.find(u=>"Quantity"==u.ID))&&(I.Formula=""),(I=this.ViewModel.ColumnSourceALL.find(u=>"Value"==u.ID))&&(I.Formula=""),(I=this.ViewModel.ColumnSourceALL.find(u=>"Expired"==u.ID))&&(I.Formula=""),this.ViewModel.ReportData=this.dvTable,this.ViewModel.ReportDataColumns=this.dsMain.Columns[0],this.ViewModel.ConstructFormulaFields(!0),this.AddProductWiseBatchWiseAgeing(),this.ViewModel.process_RunWorkerCompleted()}else if(83==this.ViewModel.StaticReportType){var R=this.ViewModel.BaseReportColumns.find(D=>181==D.CDGDO.FieldValue);let n,l;R&&"2"==R.FormulaEvaluateAtEnd.SelectedValue&&(this.HideBinQty=!0),this.dvIssue=this.dvIssueTable=this.dsMain.Tables[1],this.dvIssueColumns=this.dsMain.Columns[1],this.dsMain.Columns[0].push("Value"),this.dsMain.Columns[0].push("Expired"),this.dsMain.Columns[0].push("S0"),this.dsMain.Columns[0].push("S1"),this.dsMain.Columns[0].push("S2"),this.dsMain.Columns[0].push("S3"),this.dsMain.Columns[0].push("S4"),null!=this.SlabPercent&&(this.dsMain.Columns[0].push("P0"),this.dsMain.Columns[0].push("P1"),this.dsMain.Columns[0].push("P2"),this.dsMain.Columns[0].push("P3"),this.dsMain.Columns[0].push("P4"));for(let D=0;D<this.dsMain.Tables[0].length;D++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);l=this.dsMain.Tables[0][D],this.dblQty=parseFloat(l.Quantity),this.dvIssueColumns.Contains("BinInfo")&&(r=null,h=this.FillBinArrays(l[o].toString())),n="BatchID="+l.BatchID.toString(),this.BatchConsolidated||(n+=" AND RefInvDocDetailsID="+l.InvDocDetailsID.toString()),this.dvIssue=this.dvIssueTable.filter(this.BatchConsolidated?a=>a.BatchID==l.BatchID:a=>a.BatchID==l.BatchID&&a.RefInvDocDetailsID==l.InvDocDetailsID);for(let a=0;a<this.dvIssue.length;a++){let p=this.dvIssue[a];if(null!=h&&(r=this.FillBinArrays(p.BinInfo.toString()),null!=r))for(let V=0;V<h.length;V++){let g={Key:h.keys[V],Value:h.values[V]};g.Value>0&&r.ContainsKey(g.Key)&&r[g.Key]>0&&(g.Value>r[g.Key]?(h[g.Key]=g.Value-r[g.Key],r[g.Key]=0):(r[g.Key]=r[g.Key]-g.Value,h[g.Key]=0))}if(this.dbl=parseFloat(p.Quantity),this.dblQty=this.dblQty-this.dbl,!(this.dblQty>=0)){l.Quantity=0,p.Quantity=-this.dblQty,this.dblQty=0,null!=r&&(p.BinInfo=this.GetBinInfo(r));break}p.Quantity=0,l.Quantity=this.dblQty,null!=r&&(p.BinInfo="")}l.Value=null!=l.Rate?this.dblQty*parseFloat(l.Rate):0,0!=this.dblQty?null!=h&&(l[o]=this.GetBinInfo(h)):(this.dsMain.Tables[0].RemoveAt(D),D--)}let u=new v.bT;u.push("-1","Expired"),u.push("0","S0"),u.push("1","S1"),u.push("2","S2"),u.push("3","S3"),u.push("4","S4");let M,f="",c=0;for(this.k=0;this.k<this.dv.length;this.k++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);this.dblQty=parseFloat(this.dv[this.k].Quantity),M=u[this.dv[this.k].ID.toString()],f==this.dv[this.k].ProductID.toString()?(this.dv[c][M]=null==this.dv[c][M]?this.dblQty:parseFloat(this.dv[c][M])+this.dblQty,this.dv[c].Quantity=null==this.dv[c].Quantity?this.dv[this.k].Quantity:parseFloat(this.dv[c].Quantity)+parseFloat(this.dv[this.k].Quantity),this.dv[c].Value=parseFloat(this.dv[c].Value)+parseFloat(this.dv[this.k].Value),this.dvTable.Remove(this.dv[this.k]),this.k--):(c=this.k,f=this.dv[this.k].ProductID.toString(),this.dv[this.k][M]=this.dblQty)}if(null!=this.SlabPercent){let D;for(this.k=0;this.k<this.dv.length;this.k++)if(D=0,null!=this.dv[this.k].Quantity&&(D=parseFloat(this.dv[this.k].Quantity)),null!=this.dv[this.k].Expired&&(D-=parseFloat(this.dv[this.k].Expired)),0!=D)for(let a=0;a<=this.Slabs.length;a++)null!=this.dv[this.k]["S"+a]&&(this.dbl=parseFloat(this.dv[this.k]["S"+a]),this.dbl=100*this.dbl/D,this.dv[this.k]["P"+a]=this.dbl)}this.addProductWiseExpiryAgeing(),this.ViewModel.process_RunWorkerCompleted()}else if(84==this.ViewModel.StaticReportType){let n="";if(this.ViewModel.BaseReportColumns.filter(l=>33==l.ID.length).forEach(l=>{40==l.CDGDO.ParentCostCenterID&&(n.length>0&&(n+=","),n+=l.CDGDO.Column,this.lstPCRates.push(l.ID))}),this.dblS=new Array(this.iSlabs.length+1).fill(0),this.dsMain.Columns[0].push("BalQty"),this.dsMain.Columns[0].push("BalValue"),this.dsMain.Columns[0].push("AvgRate"),null!=this.SlabValue){this.ViewModel.RefreshPostFilters();for(let l=0;l<=this.iSlabs.length;l++)this.dsMain.Columns[0].push("SV"+l)}this.lstParents.Clear(),this.lstTotal.Clear(),this.lstParents.push(this.NewReportRow()),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.al=[],this.al.push(""),this.al.push(0),this.al.push(""),this.al.push(this.ViewModel.oReportDialog.StockDimensionID),this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere?d.J0.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?this.al.push(-1):this.al.push(this.ViewModel.oReportDialog.LocationWhere):this.al.push(null),this.al.push(this.AgeingDimWhere),this.al.push(this.strExcludeStockTransfer),this.al.push(this.ViewModel.oReportDialog.ToDate.Date),this.al.push(this.UnPostedDocsInclude),this.al.push(this.DefValuation),this.al.push(0),this.al.push(0),this.al.push(n),this.al.push(n.length>0?this.GetPriceFilter():""),this.al.push(this.CurrencyType),this.al.push(this.ForeignCurrencyID),this.al.push(this.SortTransactionsBy),this.al.push(this.exchRate),this.al.push(w.d.SessionManager.UserID),this.al.push(w.d.SessionManager.LanguageID),this.iLoop=0,this.ProductWiseAgeingCallBack()}else if(88==this.ViewModel.StaticReportType)this.AddProductWiseSubstitues(""),this.ViewModel.process_RunWorkerCompleted();else if(114==this.ViewModel.StaticReportType){this.TagID=0;let n="",l="",u="";var I;if((I=this.ViewModel.ReportColumns.filter(D=>"TAG"==D.ID)).length>0){var C=this.ViewModel.BaseReportColumns.filter(D=>"TAG"==D.ID);this.TagID=C[0].CDGDO.ColumnCostCenterID,this.TagID>5e4?n="Code"==C[0].CDGDO.Column?this.GetTagWiseQuery(this.TagID,"Code","Code"):this.GetTagWiseQuery(this.TagID,"Name","Name"):this.TagID=0}this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(l=d.J0.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN (-1)":" AND dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")",("TRUE"==w.d.SessionManager.Preferences["Division AverageRate"].toUpperCase()&&50001==this.ViewModel.oReportDialog.Locations.DBColumnID||"TRUE"==w.d.SessionManager.Preferences["Location AverageRate"].toUpperCase()&&50002==this.ViewModel.oReportDialog.Locations.DBColumnID||w.d.SessionManager.Preferences["Maintain Dimensionwise AverageRate"]==this.ViewModel.oReportDialog.Locations.DBColumnID.toString())&&(u=l));let c,f=null;this.ViewModel.Preferences.ContainsKey("DontApplyLocationFilter")&&"1"==this.ViewModel.Preferences.DontApplyLocationFilter&&(f=[50002]),l+=this.GetDimensionFilter("DCC.dcCCNID",f),c=this.ViewModel.SelectTag.Replace("@CCWHERE@",l.length>0?" INNER JOIN COM_DocCCData DCC WITH(NOLOCK) ON A.InvDocDetailsID=DCC.InvDocDetailsID "+l:""),this.iLoop=0,this.al=[],this.al.push(""),this.al.push(this.ViewModel.Preferences.ExpectedQTY1),this.al.push(this.ViewModel.Preferences.ExpectedQTY2),this.al.push(this.ViewModel.Preferences.ExpectedQTY3),this.al.push(this.ViewModel.Preferences.CommitedQTY1),this.al.push(this.ViewModel.Preferences.CommitedQTY2),this.al.push(this.ViewModel.Preferences.CommitedQTY3),this.ViewModel.Preferences.ContainsKey("SalesDocs")?this.al.push(this.ViewModel.Preferences.SalesDocs):this.al.push("");var S=this.ViewModel.BaseReportColumns.find(D=>"Months"==D.ID);this.al.push(S&&23824==S.CDGDO.FieldValue?"Gross":"UOMConvertedQty"),this.al.push(this.ViewModel.FromDatePicker.Date),this.al.push(this.ViewModel.ToDatePicker.Date),this.al.push(null!=this.MonthFromDate?this.MonthFromDate:this.ViewModel.FromDatePicker.Date),this.al.push(this.ViewModel.DontApplyDateFilter),this.al.push(this.TagID),this.al.push(n),this.al.push(l),this.al.push(c),this.al.push(this.ViewModel.FromTag),this.al.push(u),this.al.push(w.d.SessionManager.UserID),this.al.push(w.d.SessionManager.LanguageID),this.IsPCodeLink=null!=this.oColumns.find(D=>"ProductCode"==D.ID&&(D.LinkType==N.T6.Dimension||D.LinkType==N.T6.DimensionNode)),this.IsPNameLink=null!=this.oColumns.find(D=>"ProductName"==D.ID&&(D.LinkType==N.T6.Dimension||D.LinkType==N.T6.DimensionNode)),this.ShowDetailReport=!(!this.ViewModel.Preferences.ContainsKey("ShowDetailReport")||"1"!=this.ViewModel.Preferences.ShowDetailReport),this.TempRTVisible=this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible,this.ItemMasterCallBack()}else if(115==this.ViewModel.StaticReportType){let n="";this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(n=d.J0.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN (-1)":" AND dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")"),n+=this.GetDimensionFilter("DCC.dcCCNID"),this.al=[],this.al.push(""),this.al.push(this.ViewModel.Preferences.ExpectedQTY1),this.al.push(this.ViewModel.Preferences.ExpectedQTY2),this.al.push(this.ViewModel.Preferences.ExpectedQTY3),this.al.push(this.ViewModel.Preferences.CommitedQTY1),this.al.push(this.ViewModel.Preferences.CommitedQTY2),this.al.push(this.ViewModel.Preferences.CommitedQTY3),this.ViewModel.Preferences.ContainsKey("SalesDocs")?this.al.push(this.ViewModel.Preferences.SalesDocs):this.al.push(""),this.al.push(this.ViewModel.FromDatePicker.Date),this.al.push(this.ViewModel.ToDatePicker.Date),this.al.push(n),this.al.push(w.d.SessionManager.UserID),this.al.push(w.d.SessionManager.LanguageID),this.ExtraColumns=new Array,this.oColumns.forEach(l=>{33==l.ID.length&&this.dsMain.Columns[0].Contains(l.ID)&&this.ExtraColumns.push(l)}),this.iLoop=0,this.SalesAnalysisCallBack()}})}catch(e){return void Logger.ErrorLog("INV_Ageing::Error LoadReport ",e)}}ProductWiseAgeingCallBack(){{if(this.iLoop>=this.dsMain.Tables[0].length)return void this.ProductWiseAgeingCallBack_Complete();if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);let t;this.sbChunks="";for(let e=this.iLoop;e<this.dsMain.Tables[0].length&&e-this.iLoop<this.ChunkSize;e++)(!this.ShowLevelTree||!(0,y.yG0)(this.dsMain.Tables[0][e].IsGroup))&&(this.sbChunks.length>0&&(this.sbChunks+=","),this.sbChunks+=this.dsMain.Tables[0][e].ProductID.toString());this.al[0]=this.sbChunks.toString(),w.d.report.GetStockValuation(this.al,this.ViewModel.IsReportDB).then(e=>{this.ds=e,t=this.ds.Tables[0];for(let s=this.iLoop;s<this.dsMain.Tables[0].length&&s-this.iLoop<this.ChunkSize;s++){if(this.drMain=this.dsMain.Tables[0][s],this.strProductID=this.drMain.ProductID.toString(),t=this.ds.Tables[0].filter(i=>i.ProductID==this.strProductID),t.length>0?(this.drMain.BalValue=t[0].BalValue,this.drMain.AvgRate=t[0].AvgRate):this.drMain.AvgRate=0,this.lstPCRates.length>0&&!d.J0.IsEmpty(t.PCxml)){this.lstPCRates.forEach(o=>{this.dsMain.Columns[0].Contains(o)||this.dsMain.Columns[0].push(o)});let i=t[0].PCxml.toString().split(",");for(let o=0;o<this.lstPCRates.length&&o<i.length;o++)this.drMain[this.lstPCRates[o]]=i[o]}this.ViewModel.lstGroup.length>0&&this.ViewModel.AddGroupRows(this.dsMain.Tables[0],s),this.addProductWiseAgeingRow()}this.ViewModel.refreshDataView(),this.iLoop+=this.ChunkSize,this.ProductWiseAgeingCallBack()},e=>{this.ProductWiseAgeingCallBack_Complete()})}}ProductWiseAgeingCallBack_Complete(){this.ShowLevelTree&&this.UpdateTreeTotals(0),this.ViewModel.CheckAndAddTotals(this.dsMain.Tables[0]),this.ViewModel.process_RunWorkerCompleted()}ItemMasterCallBack(){{if(this.iLoop>=this.dsMain.Tables[0].length)return void this.ItemMasterCallBack_Complete();if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);let i,r,T,t=this.ChunkSize,e=null,s=null,o=null,h=null;this.ChunkSize=this.ViewModel.ReportViewType==N.Zv.Query?0==this.iLoop?1:t:this.ShowDetailReport?t:1,this.sbChunks="";for(let I=this.iLoop;I<this.dsMain.Tables[0].length&&I-this.iLoop<this.ChunkSize;I++)this.sbChunks.length>0&&(this.sbChunks+=","),this.sbChunks+=this.dsMain.Tables[0][I][this.dsMain.Columns[0][0]].toString();this.al[0]=this.sbChunks.toString(),w.d.report.GetItemMaster(this.al,this.ViewModel.IsReportDB).then(I=>{this.ds=I;for(let C=1;C<this.ds.Columns[1].length;C++)this.ds.Columns[0].push(this.ds.Columns[1][C]);(this.IsPCodeLink||this.IsPNameLink)&&(this.IsPCodeLink&&this.ds.Columns[0].push("ProductCode_ID"),this.IsPNameLink&&this.ds.Columns[0].push("ProductName_ID"),this.ds.Tables[0].forEach(C=>{this.IsPCodeLink&&(C.ProductCode_ID=C.ProductID),this.IsPNameLink&&(C.ProductName_ID=C.ProductID)})),this.dv=this.dvTable=this.ds.Tables[0],i=r=this.ds.Tables[1],T=this.ds.Columns[1],this.dvIssue=this.dvIssueTable=this.ds.Tables[2],s=h=this.ds.Tables[3],this.TagID>0&&(e=o=this.ds.Tables[0]),this.DataSetCollection.push(this.ds);for(let C=0;C<=this.CntMonths;C++)this.ds.Columns[0].push("M"+C);let R;this.ds.Columns[0].push("MonthsTotal"),this.ds.Columns[0].push("AvgMovement"),this.ds.Columns[0].push("Months");for(let C=this.iLoop;C<this.dsMain.Tables[0].length&&C-this.iLoop<this.ChunkSize;C++)if(this.drMain=this.dsMain.Tables[0][C],this.strProductID=this.drMain[this.dsMain.Columns[0][0]].toString(),this.dv=this.dvTable.filter(S=>S.ProductID==this.strProductID),R=0,this.dv.length>0){if(this.TagID>0){let S=this.dv[0];this.dvIssue=this.dvIssueTable.filter(n=>n.ProductID==this.strProductID),this.dvIssue.forEach(n=>{if(e=o.filter(l=>l.ProductID==this.strProductID&&l.TagID==n.TagID),0==e.length){let l;e=o.filter(u=>u.ProductID==this.strProductID&&0==u.TagID),0==e.length?(l=this.ds.Tables[0].NewRow(),l.ProductID=S.ProductID.toString(),l.ProductCode=S.ProductCode.toString(),l.ProductName=S.ProductName.toString(),l.TagID=n.TagID.toString(),this.ds.Tables[0].InsertAt(l,this.ds.Tables[0].indexOf(this.dv[this.dv.length-1]))):(l=e[0],l.TagID=n.TagID.toString()),e=o.filter(u=>u.ProductID==this.strProductID&&u.TagID==n.TagID)}-1!=this.colMonthIndex&&(e[0]["M"+n.Mn.toString()]=n.Qty,null!=n.Qty&&(e[0].Months=null==e[0].Months?parseFloat(n.Qty):parseFloat(e[0].Months)+parseFloat(n.Qty)))}),this.dv.forEach(n=>{s=h.filter(l=>l.ProductID==this.strProductID&&l.TagID==n.TagID),s.length>0&&(n.MonthsTotal=s[0].Qty,n.AvgMovement=parseFloat(s[0].Qty)/(this.CntMonths+1))})}else{let S=0;this.dvIssue=this.dvIssueTable.filter(n=>n.ProductID==this.strProductID),s=h.filter(n=>n.ProductID==this.strProductID),-1!=this.colMonthIndex&&this.dvIssue.forEach(n=>{this.dv[0]["M"+n.Mn.toString()]=n.Qty,null!=n.Qty&&(S+=parseFloat(n.Qty))}),s.length>0&&(this.dv[0].MonthsTotal=s[0].Qty,this.dv[0].AvgMovement=parseFloat(s[0].Qty)/(this.CntMonths+1)),this.dv[0].Months=S}i=r.filter(S=>S.ProductID==this.strProductID),i.length>0&&this.dv.forEach(S=>{for(let n=1;n<T.length;n++)S[T[n]]=i[0][T[n]]})}this.ViewModel.ReportData=this.ds.Tables[0],this.ViewModel.ReportDataColumns=this.ds.Columns[0],this.ViewModel.ConstructFormulaFields(!0),this.dv=this.dvTable,this.ViewModel.RenderData(this.dv,this.ds.Columns[0]),this.iLoop+this.ChunkSize<this.dsMain.Tables[0].length&&(this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible=!1,this.ViewModel.CheckAndAddTotals(this.dv),this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible=this.TempRTVisible),this.ViewModel.refreshDataView(),this.iLoop+=this.ChunkSize,this.ItemMasterCallBack()})}}ItemMasterCallBack_Complete(){this.ViewModel.CheckAndAddTotals(this.dv),this.ViewModel.process_RunWorkerCompleted()}SalesAnalysisCallBack(){if(this.iLoop>=this.dsMain.Tables[0].length)this.SalesAnalysisCallBack_Complete();else if(this.ViewModel.process.CancellationPending)this.ViewModel.processArgs.Cancel=!0;else{this.sbChunks="";for(let t=this.iLoop;t<this.dsMain.Tables[0].length&&t-this.iLoop<this.ChunkSize;t++)this.sbChunks.length>0&&(this.sbChunks+=","),this.sbChunks+=this.dsMain.Tables[0][t][this.dsMain.Columns[0][0]].toString();this.al[0]=this.sbChunks.toString(),w.d.report.GetSalesAnalasys(this.al,this.ViewModel.IsReportDB).then(t=>{this.ds=t,this.dv=this.dvTable=this.ds.Tables[0],this.dvIssue=this.dvIssueTable=this.ds.Tables[1],this.dvIssueColumns=this.ds.Columns[1],this.DataSetCollection.push(this.ds);for(let s=0;s<=this.CntMonths;s++)this.ds.Columns[0].push("M"+s);let e;this.ds.Columns[0].push("AvgMovement"),this.ds.Columns[0].push("MonthsTotal"),this.ExtraColumns.forEach(s=>{this.ds.Columns[0].Contains(s.ID)||this.ds.Columns[0].push(s.ID)});for(let s=this.iLoop;s<this.dsMain.Tables[0].length&&s-this.iLoop<this.ChunkSize;s++)this.drMain=this.dsMain.Tables[0][s],this.strProductID=this.drMain[this.dsMain.Columns[0][0]].toString(),this.dv=this.dvTable.filter(i=>i.ProductID==this.strProductID),e=0,this.dv.length>0&&(this.dvIssue=this.dvIssueTable.filter(i=>i.ProductID==this.strProductID),this.dvIssue.forEach(i=>{this.dv[0]["M"+i.Mn.toString()]=i.Qty,e+=parseFloat(i.Qty)}),this.dv[0].MonthsTotal=e,this.dv[0].AvgMovement=e/this.CntMonths,this.ExtraColumns.forEach(i=>{this.dv[0][i.ID]=this.drMain[i.ID].toString()}));this.ViewModel.ReportData=this.ds.Tables[0],this.ViewModel.ReportDataColumns=this.ds.Columns[0],this.ViewModel.ConstructFormulaFields(!0),this.dv=this.dvTable,this.ViewModel.RenderData(this.dv,this.ds.Columns[0]),this.ViewModel.refreshDataView(),this.iLoop+=this.ChunkSize,this.SalesAnalysisCallBack()})}}SalesAnalysisCallBack_Complete(){this.ViewModel.ReportData=null,this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible&&this.ViewModel.AddSubtotals_RT(this.ViewModel.GrpReportTotal,0),this.ViewModel.process_RunWorkerCompleted()}FillBinArrays(t){let e;if(t.length>0){let s=t.split(",");e=new v.bT;for(let i=0;i<s.length;i++){let o=s[i].indexOf("-"),h=parseFloat(s[i].substr(o+1));s[i]=s[i].substr(0,o+1).TrimStart(" "),e.ContainsKey(s[i])?e[s[i]]+=h:e.push(s[i],h)}}else e=null;return e}GetBinInfo(t){let e="";return t?.keys.forEach(s=>{let i={Key:s,Value:t[s]};i.Value>0&&(e.length>0&&(e+=", "),e+=this.HideBinQty?i.Key.TrimEnd("-"):i.Key+i.Value)}),e}LoadReportWithPostFilters(t){if(this.GrdRow=-1,this.AggTotal=d.J0.NumArray(this.oColumns.length,2),this.ViewModel.ClearRows(),this.ViewModel.totals=d.J0.NumArray(this.oColumns.length,this.ViewModel.lstGroup.length+1),this.dv=A.d.FilterData(this.dvTable,this.ViewModel.PostDataFetchFilterFields),null!=this.lstTotal&&(this.lstTotal.Clear(),this.lstParents.Clear(),this.lstParents.push(this.NewReportRow()),this.lstTotal.push(new Array(this.oColumns.length).fill(0))),82==this.ViewModel.StaticReportType)this.AddProductWiseBatchWiseAgeing();else if(83==this.ViewModel.StaticReportType)this.addProductWiseExpiryAgeing();else if(84==this.ViewModel.StaticReportType)this.addProductWiseAgeing();else if(88==this.ViewModel.StaticReportType)this.AddProductWiseSubstitues(t);else if(114==this.ViewModel.StaticReportType){this.ViewModel.Preferences.ContainsKey("ShowDetailReport");let i=this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible;for(let o=0,h=0;o<this.dsMain.Tables[0].length;o+=this.ChunkSize,h++)this.ds=this.DataSetCollection[h],this.dv=this.ds.Tables[0],this.ViewModel.ReportData=this.ds.Tables[0],this.dv=A.d.FilterData(this.dv,this.ViewModel.PostDataFetchFilterFields),this.ViewModel.RenderData(this.dv),o+this.ChunkSize<this.dsMain.Tables[0].length&&(this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible=!1,this.ViewModel.CheckAndAddTotals(this.dv),this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible=i);this.ViewModel.CheckAndAddTotals(this.dv)}else if(115==this.ViewModel.StaticReportType){for(let e=0,s=0;e<this.dsMain.Tables[0].length;e+=this.ChunkSize,s++)this.ds=this.DataSetCollection[s],this.dv=this.ds.Tables[0],this.ViewModel.ReportData=this.ds.Tables[0],this.dv=A.d.FilterData(this.dv,this.ViewModel.PostDataFetchFilterFields),this.ViewModel.RenderData(this.dv);this.ViewModel.CheckAndAddTotals(this.dv)}this.ViewModel.refreshDataView()}GetQuery(){let t="",e="",s="",i=this.ViewModel.oReportDialog.GetSeqNosListWithRoots();!this.ViewModel.oReportDialog.IsZeroSelected&&!this.ViewModel.oReportDialog.IsOneSelected&&(this.ViewModel.oReportDialog.IsGroupExists?(s=" AND P.ProductID=GTP.GTID",e=i.Contains(",")?",(select T.ProductID GTID from INV_Product T with(nolock),INV_Product GT1 with(nolock) where T.lft BETWEEN GT1.lft AND GT1.rgt AND GT1.ProductID IN ("+i+") group by T.ProductID) AS GTP ":",(select T.ProductID GTID from INV_Product T with(nolock),INV_Product GT1 with(nolock) where T.lft BETWEEN GT1.lft AND GT1.rgt AND GT1.ProductID="+i+" group by T.ProductID) AS GTP "):s=i.Contains(",")?" AND P.ProductID IN ("+i+")":" AND P.ProductID="+i);let o=this.ViewModel.GetCostCenterFilter(113,"D.StatusID");0==o.length&&(o=" and D.StatusID=369");let h=this.ViewModel.GetCostCenterFilter(2,"PVG.AccountID");if(1==this.ViewModel.ReportGroups.length&&2==this.ViewModel.ReportGroups[0].CDGDO.ColumnCostCenterID||0!=h.length&&(h=" AND P.ProductID in (select distinct PVG.ProductID from INV_ProductVendors PVG with(nolock) "+e+" WHERE 1=1 "+h+s.Replace(" P."," PVG.")+") "),82==this.ViewModel.StaticReportType){let r="",T="",I="",R="D.UOMConvertedQty";this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(I=d.J0.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND 1<>1":" AND DCC.dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")"),I+=this.GetDimensionFilter("DCC.dcCCNID"),T+=I,(T.length>0||this.ViewModel.FromTag.Contains("DCC.dcCCNID"))&&(r=" INNER JOIN COM_DocCCData DCC WITH(NOLOCK) ON D.InvDocDetailsID=DCC.InvDocDetailsID "+this.ViewModel.FromTag),s=s.Replace("P.ProductID","B.ProductID"),t+="DECLARE @AsOn FLOAT\nSET @AsOn=CONVERT(FLOAT,CONVERT(DATETIME,'"+this.ViewModel.oReportDialog.ToDate.Date.ToString("dd MMM yyyy")+"'))",this.ViewModel.GroupFromTag.Contains("BIN.NodeID")?(this.IsBinDetail=!0,R="isnull(BD.Quantity*D.UOMConversion,D.UOMConvertedQty)",this.ViewModel.SelectTag+=",isnull(BIN.NodeID,0) BinNodeID"):this.IsBinDetail=!1,t+="\nSELECT 'Code :'+P.ProductCode+'    Name :'+P.ProductName ProductName,B.BatchNumber,B.BatchID,D.InvDocDetailsID,CONVERT(DATETIME,B.ExpiryDate) ExpDate,CONVERT(DATETIME,B.MfgDate) MfgDate,"+R+" Quantity,D.Rate,"+R+"*D.Rate Value\n"+this.ViewModel.SelectTag+this.ViewModel.GroupSelectTag+"\nFROM INV_DocDetails D WITH(NOLOCK)\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+r+this.ViewModel.GroupFromTag+e,t+=" WHERE D.BatchID>1 and D.VoucherType=1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn and B.ExpiryDate is not null"+o,s.length>0&&(t+=s),t+=T,t+=this.IsBinDetail?" Order By P.ProductName,D.DocDate,BatchNumber,BinNodeID,D.Rate,B.MfgDate":" Order By P.ProductName,D.DocDate,BatchNumber,D.Rate,B.MfgDate",this.IsBinDetail&&(r+="  left join INV_BinDetails BD with(nolock) on BD.InvDocDetailsID=D.InvDocDetailsID"),this.BatchConsolidated?(t+="\nSELECT B.BatchID,SUM("+R+") Quantity",this.IsBinDetail&&(t+=",isnull(BD.BinID,0) BinNodeID"),t+="\nFROM INV_DocDetails D WITH(NOLOCK)\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+r+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND (D.RefInvDocDetailsID=0 OR D.RefInvDocDetailsID IS NULL) "+s,t+=T+o,t+=" GROUP BY B.BatchID",this.IsBinDetail&&(t+=",BD.BinID")):(t+="\nSELECT D.InvDocDetailsID,D.RefInvDocDetailsID, B.BatchID,"+R+" Quantity",this.IsBinDetail?t+=",isnull(BD.BinID,0) BinNodeID":this.ViewModel.ReportParams.ContainsKey("BinInfo")&&this.ViewModel.ReportParams.BinInfo.length>0&&(t+=","+this.ViewModel.ReportParams.BinInfo+" BinInfo"),t+="\nFROM INV_DocDetails D WITH(NOLOCK)\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN [INV_Product] P WITH(NOLOCK) ON B.ProductID=P.ProductID"+r+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND D.RefInvDocDetailsID>0 "+s,t+=T+o)}else if(83==this.ViewModel.StaticReportType){let r="";this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(r=d.J0.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND 1<>1":" AND DCC.dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")"),r+=this.GetDimensionFilter("DCC.dcCCNID"),r.length>0&&(r=" INNER JOIN COM_DocCCData DCC WITH(NOLOCK) ON D.InvDocDetailsID=DCC.InvDocDetailsID "+r);let T=this.BatchConsolidated?"":"D.InvDocDetailsID,";this.ViewModel.ReportParams.ContainsKey("BinInfo"),t+="declare @AsOn FLOAT\ndeclare @Tbl As Table(ID INT,FromDate FLOAT,ToDate FLOAT)\nset @AsOn=CONVERT(FLOAT,CONVERT(DATETIME,'"+this.ViewModel.oReportDialog.ToDate.Date.ToString("dd MMM yyyy")+"'))",t+="\nINSERT INTO @Tbl VALUES(-1,0,@AsOn-1)\nINSERT INTO @Tbl VALUES(0,@AsOn,@AsOn+"+(this.iSlabs[0]-1)+")\nINSERT INTO @Tbl VALUES(1,@AsOn+"+this.iSlabs[0]+",@AsOn+"+(this.iSlabs[1]-1)+")\nINSERT INTO @Tbl VALUES(2,@AsOn+"+this.iSlabs[1]+",@AsOn+"+(this.iSlabs[2]-1)+")\nINSERT INTO @Tbl VALUES(3,@AsOn+"+this.iSlabs[2]+",@AsOn+"+(this.iSlabs[3]-1)+")\nINSERT INTO @Tbl VALUES(4,@AsOn+"+this.iSlabs[3]+",123456)\n",t+="SELECT "+T+"T.ID,D.ProductID,B.BatchID,P.ProductCode,P.ProductName,SUM(D.UOMConvertedQty) Quantity,MAX(D.Rate) Rate\n"+this.ViewModel.GroupSelectTag+"\nFROM INV_DocDetails D WITH(NOLOCK) "+r+"\nINNER JOIN INV_Batches B WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN @Tbl T ON B.ExpiryDate BETWEEN T.FromDate AND T.ToDate\n",t+=this.ShowLevelTree?" RIGHT JOIN INV_Product P WITH(NOLOCK) ON P.ProductID=D.ProductID":" INNER JOIN INV_Product P WITH(NOLOCK) ON P.ProductID=D.ProductID",t+=this.ViewModel.FromTag+this.ViewModel.GroupFromTag,t+=e,t+="\nWHERE D.BatchID>1 and (D.VoucherType=1 and D.IsQtyIgnored=0) AND D.DocDate<=@AsOn and B.ExpiryDate is not null",t+=o,this.ShowLevelTree?t+=" AND P.ProductID<>1 AND (D.Quantity IS NOT NULL OR P.IsGroup=1)"+s:s.length>0&&(t+=s),t+="\nGROUP BY "+T+"D.ProductID,B.BatchID,P.ProductCode,P.ProductName,T.ID,D.DocDate,D.Rate\nORDER BY P.ProductName,D.ProductID,B.BatchID,D.DocDate,T.ID,Rate",this.BatchConsolidated?(t+="\nSELECT B.BatchID,SUM(D.UOMConvertedQty) Quantity\nFROM INV_DocDetails D WITH(NOLOCK)"+r+"\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND (D.RefInvDocDetailsID=0 OR D.RefInvDocDetailsID IS NULL) ",t+=o,t+=s,t+=" GROUP BY B.BatchID"):this.ViewModel.ReportParams.ContainsKey("BinInfo")&&this.ViewModel.ReportParams.BinInfo.length>0?(t+="\nSELECT D.RefInvDocDetailsID,B.BatchID,D.UOMConvertedQty Quantity,"+this.ViewModel.ReportParams.BinInfo+" BinInfo\nFROM INV_DocDetails D WITH(NOLOCK)"+r+"\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND D.RefInvDocDetailsID>0 ",t+=o,t+=s):(t+="\nSELECT D.RefInvDocDetailsID,B.BatchID,SUM(D.UOMConvertedQty) Quantity\nFROM INV_DocDetails D WITH(NOLOCK)"+r+"\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND D.RefInvDocDetailsID>0 ",t+=o,t+=s,t+=" GROUP BY D.RefInvDocDetailsID,B.BatchID")}else if(84==this.ViewModel.StaticReportType){let r="",T=!1,I=!1,R=!1;this.ViewModel.Preferences.ContainsKey("DisplayStock")&&(this.ViewModel.Preferences.DisplayStock.Contains("Zero")&&(R=!0),this.ViewModel.Preferences.DisplayStock.Contains("Positive")&&(T=!0),this.ViewModel.Preferences.DisplayStock.Contains("Negative")&&(I=!0),!T&&!I&&!R&&(T=I=R=!0));let C=0,S="",n="",l="",u="",M="",f="",c="";this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(c=d.J0.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND 1<>1":" AND DCC.dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")"),c+=this.GetDimensionFilter("DCC.dcCCNID"),1==this.ViewModel.ReportGroups.length&&(2==this.ViewModel.ReportGroups[0].CDGDO.ColumnCostCenterID||this.ViewModel.ReportGroups[0].CDGDO.ColumnCostCenterID>5e4)&&(C=this.ViewModel.ReportGroups[0].CDGDO.ColumnCostCenterID,C>5e4?(n=",DCC.dcCCNID"+(C-5e4)+" TAGID",l=",DCC.dcCCNID"+(C-5e4),u=",TAGID",S=b.GetTagTableName(C),M=",TG.Name AS "+this.ViewModel.ReportGroups[0].ID,f="TG.Name,",S=" INNER JOIN "+b.GetTagTableName(C)+" TG WITH(NOLOCK) ON TG.NodeID=TBL.TagID"):(M=",TG.AccountName AS "+this.ViewModel.ReportGroups[0].ID,S=" LEFT JOIN INV_ProductVendors PVG WITH(NOLOCK) ON PVG.ProductID=TBL.ProductID\n                           LEFT JOIN ACC_Accounts TG WITH(NOLOCK) ON PVG.AccountID=TG.AccountID")),C>0&&(this.ShowLevelTree=!1),this.AgeingDimWhere=c,(C>5e4||c.length>0)&&(c=" INNER JOIN COM_DocCCData DCC WITH(NOLOCK) ON D.InvDocDetailsID=DCC.InvDocDetailsID "+c),this.ForeignCurrencyID>0&&(r+=" AND D.CurrencyID="+this.ForeignCurrencyID),r+=o,this.strExcludeStockTransfer=E.M.GetExcludeStockTransfer(this.ViewModel),r+=this.strExcludeStockTransfer,this.ViewModel.Preferences.ContainsKey("ExcludeOtherTransferInSales")&&this.ViewModel.Preferences.ExcludeOtherTransferInSales.length>0&&(r+=" AND D.CostCenterID NOT IN ("+this.ViewModel.Preferences.ExcludeOtherTransferInSales+")"),null!=this.ViewModel.ColumnSource.find(a=>"SerialNumbers"==a.ID&&a.HeaderAppearance.IsVisible)&&(this.ViewModel.SelectTag+=",STUFF(\n(select ', '+S.SerialNumber from INV_SerialStockProduct S with(nolock)\ninner join Inv_DocDetails D with(nolock) on D.InvDocDetailsID=S.InvDocDetailsID\nwhere S.IsAvailable=1 and D.ProductID=P.ProductID FOR XML PATH('')),1,1,'') SerialNumbers"),t+="DECLARE @AsOn FLOAT\nSET @AsOn=CONVERT(FLOAT,CONVERT(DATETIME,'"+this.ViewModel.oReportDialog.ToDate.Date.ToString("dd MMM yyyy"),t+="')) \nSELECT P.ProductCode,P.ProductName"+M+",P.ProductID"+this.ViewModel.SelectTag;for(let a=0;a<=this.iSlabs.length;a++)t+=",S"+a;if(t+=",Issue",this.ShowLevelTree&&(t+=",P.IsGroup,P.Depth"),this.ShowYearWise){t+=" FROM ( SELECT ProductID"+u;for(let a=0;a<=this.iSlabs.length;a++)t+=",SUM(S"+a+") S"+a;t+=",SUM(Issue) Issue FROM (";for(let a=0;a<=this.iSlabs.length;a++){a>0&&(t+="\nUNION ALL "),t+="\nSELECT D.ProductID"+n;for(let p=0;p<=this.iSlabs.length;p++)t+=a==p?",SUM(D.UOMConvertedQty) S"+p:",0 S"+p;t+=",0 Issue",t+="\nFROM INV_DocDetails D WITH(NOLOCK) "+c+"\nWHERE D.VoucherType=1 and D.IsQtyIgnored=0 AND ",t+=0==a?"(D.DocDate<=@AsOn AND D.DocDate>=convert(float,convert(datetime,'"+this.Slabs[a].ToString("dd MMM yyyy")+"')))":a==this.iSlabs.length?"D.DocDate<convert(float,convert(datetime,'"+this.Slabs[a-1].ToString("dd MMM yyyy")+"'))":"(D.DocDate<convert(float,convert(datetime,'"+this.Slabs[a-1].ToString("dd MMM yyyy")+"')) AND D.DocDate>=convert(float,convert(datetime,'"+this.Slabs[a].ToString("dd MMM yyyy")+"')))",t+=r,t+=" GROUP BY D.ProductID"+l}t+="\nUNION ALL\nSELECT D.ProductID"+n;for(let a=0;a<=this.iSlabs.length;a++)t+=",0 S"+a;t+=",SUM(D.UOMConvertedQty) Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+c+"\nWHERE D.VoucherType=-1 and D.IsQtyIgnored=0 AND D.DocDate<=@AsOn"+r+"\nGROUP BY D.ProductID"+l+"\n\n) AS TBL2\nGROUP BY  ProductID"+u+") AS TBL"}else{let a=this.iSlabs[0],p="";t+=" FROM ( SELECT ProductID"+u;for(let V=0;V<=this.iSlabs.length;V++)t+=",SUM(S"+V+") S"+V,p+="SLAB S"+V+",";t+=",SUM(Issue) Issue FROM (\n\nSELECT D.ProductID"+n+","+p.Replace("SLAB S0,","SUM(D.UOMConvertedQty) S0,").Replace("SLAB","0")+"0 Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+c+"\nWHERE D.VoucherType=1 and D.IsQtyIgnored=0 AND (D.DocDate<=@AsOn AND D.DocDate>@AsOn-"+this.iSlabs[0]+")"+r+"\nGROUP BY D.ProductID"+l;for(let V=1;V<this.iSlabs.length;V++)this.iSlabs[V]>this.iSlabs[V-1]&&(a=this.iSlabs[V],t+="\nUNION\nSELECT D.ProductID"+n+","+p.Replace("SLAB S"+V+",","SUM(D.UOMConvertedQty) S"+V+",").Replace("SLAB","0"),t+="0 Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+c+"\nWHERE D.VoucherType=1 and D.IsQtyIgnored=0 AND (D.DocDate<=@AsOn-"+this.iSlabs[V-1]+" AND D.DocDate>@AsOn-"+this.iSlabs[V]+")"+r+"\nGROUP BY D.ProductID"+l);t+="\nUNION\nSELECT D.ProductID"+n+","+p.Replace("SLAB S"+this.iSlabs.length+",","SUM(D.UOMConvertedQty) S"+this.iSlabs.length+",").Replace("SLAB","0")+"0 Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+c+"\nWHERE D.VoucherType=1 and D.IsQtyIgnored=0 AND (D.DocDate<=@AsOn-"+a+")"+r+"\nGROUP BY D.ProductID"+l+"\nUNION\nSELECT D.ProductID"+n+","+p.Replace("SLAB","0")+"SUM(D.UOMConvertedQty) Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+c+"\nWHERE D.VoucherType=-1 and D.IsQtyIgnored=0 AND D.DocDate<=@AsOn"+r+"\nGROUP BY D.ProductID"+l+"\n\n) AS TBL2\nGROUP BY  ProductID"+u+") AS TBL"}let D="";if(!T||!I||!R){let a="S0";for(let p=1;p<=this.iSlabs.length;p++)a+="+S"+p;T&&(D="("+a+"-Issue)>0"),I&&(D.length>0&&(D+=" OR "),D+="("+a+"-Issue)<0"),R&&(D.length>0&&(D+=" OR "),D+="("+a+"-Issue)=0")}this.ShowLevelTree?(t+=" RIGHT JOIN INV_Product P WITH(NOLOCK) ON P.ProductID=TBL.ProductID"+this.ViewModel.FromTag+e,t+=" WHERE P.ProductID<>1 AND P.ProductTypeID!=6 AND P.ProductTypeId!=10 AND ",t+="((TBL.S0 IS NOT NULL",D.length>0&&(t+=" AND ("+D+")"),t+=")",t+="OR P.IsGroup=1)",t+=s,t+=h,d.J0.IsEmpty(this.ViewModel.RowFiltersWhere)||(t+=" AND "+this.ViewModel.RowFiltersWhere),t+=" ORDER BY P.lft"):(t+=" INNER JOIN INV_Product P WITH(NOLOCK) ON P.ProductID=TBL.ProductID"+S+this.ViewModel.FromTag+e,t+=" WHERE P.ProductTypeID!=6 AND P.ProductTypeId!=10 and P.IsGroup=0",t+=s,t+=h,D.length>0&&(t+=" AND ("+D+")"),d.J0.IsEmpty(this.ViewModel.RowFiltersWhere)||(t+=" AND "+this.ViewModel.RowFiltersWhere))}else 88==this.ViewModel.StaticReportType?(t+='SELECT MS.[ProductID],S.[ProductID] SProductID,P.ProductCode SCode,P.ProductName SName,ISNULL((SELECT SUM(D.UOMConvertedQty*D.VoucherType) FROM INV_DocDetails D WITH(NOLOCK)\nWHERE D.ProductID=S.ProductID AND D.IsQtyIgnored=0 " + StatusWhere + @"),0) QOH\n            FROM [INV_ProductSubstitutes] MS WITH(NOLOCK)\nLEFT JOIN [INV_ProductSubstitutes] S WITH(NOLOCK) ON MS.[SubstituteGroupID]=S.[SubstituteGroupID]\nINNER JOIN INV_Product P WITH(NOLOCK) ON P.[ProductID]=S.[ProductID]'+e,s.length>0&&(s=s.Replace("P.ProductID","MS.ProductID"),t+=" WHERE 1=1 "+s),t+=" GROUP BY  MS.[ProductID],S.[ProductID],P.ProductCode,P.ProductName",t+="\nSELECT MS.[ProductID],MS.[SubstituteGroupName] FROM [INV_ProductSubstitutes] MS WITH(NOLOCK)"+e,s.length>0&&(t+=" WHERE 1=1"+s),t+=" group by MS.[ProductID],MS.[SubstituteGroupName]"):114==this.ViewModel.StaticReportType?this.ViewModel.ReportViewType!=N.Zv.Query||i.Contains(",")||"1"==i?this.ViewModel.Preferences.ContainsKey("ShowDetailReport")&&"1"==this.ViewModel.Preferences.ShowDetailReport?(t+="SELECT P.ProductID,P.ProductName FROM INV_Product P WITH(NOLOCK)"+e,t+=" WHERE P.IsGroup=0"+s,t+=" Order By P.lft"):(this.LevelNo=6,this.ViewModel.Preferences.ContainsKey("Level")&&d.J0.IsNum(this.ViewModel.Preferences.Level)&&(this.LevelNo=d.J0.Int(this.ViewModel.Preferences.Level)),t+="SELECT P.ProductID,P.ProductName FROM INV_Product P WITH(NOLOCK)"+e,t+=" WHERE P.IsGroup=1 AND P.Depth<="+this.LevelNo+s,t+=" Order By P.ProductName"):this.ViewModel.Preferences.ContainsKey("ShowDetailReport")&&"1"==this.ViewModel.Preferences.ShowDetailReport?t+="select ProductID,ProductName,lft from INV_Product WITH(NOLOCK) where productid="+i+" OR (IsGroup=0 and lft>(select lft from inv_product WITH(NOLOCK) where productid="+i+") and rgt<(select rgt from inv_product WITH(NOLOCK) where productid="+i+")) order by lft":t+="select ProductID,ProductName from INV_Product WITH(NOLOCK) where productid="+i:115==this.ViewModel.StaticReportType&&(t+="SELECT P.ProductID,P.ProductName,P.ValuationID "+this.ViewModel.SelectTag+" FROM INV_Product P WITH(NOLOCK)"+e,t+=this.ViewModel.FromTag,t+=" WHERE P.IsGroup=0 "+s,t+=" Order By P.ProductName");return t.toString()}GetUsedProductsByTagQuery(t,e,s){let i="";e=e.Replace("P.ProductID","D.ProductID");let o="";return this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(o=" AND DCC.dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4),d.J0.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?o+="=-1":this.ViewModel.oReportDialog.LocationWhere.Contains(",")?o+=" IN ("+this.ViewModel.oReportDialog.LocationWhere+")":o+="="+this.ViewModel.oReportDialog.LocationWhere),o+=this.GetDimensionFilter("DCC.dcCCNID"),i+="SELECT DCC.dcCCNID"+(this.TagID-5e4)+" NodeID,max("+s+") Name FROM Inv_DocDetails D WITH(NOLOCK)",i+=" inner join COM_DocCCDATA DCC with(nolock) on DCC.InvDocDetailsID=D.InvDocDetailsID",i+=" inner join "+b.GetTagTableName(this.TagID)+" T with(nolock) on T.NodeID=DCC.dcCCNID"+(this.TagID-5e4),i+=" inner join INV_Product P with(nolock) on P.ProductID=D.ProductID",i+=t,i+=" WHERE (D.VoucherType=1 OR D.VoucherType=-1) AND D.IsQtyIgnored=0",i+=" AND D.DocDate<=convert(float,convert(datetime,'"+this.ViewModel.oReportDialog.ToDate.Date.ToString("dd MMM yyyy")+"'))",i+=o,i+=e,i+=E.M.GetExcludeStockTransfer(this.ViewModel),i+=this.GetProductWiseLocationWhere("P",!1),i+=" GROUP BY DCC.dcCCNID"+(this.TagID-5e4),i.toString()}AddReportTotals(){this.UpdateTreeTotals(0),this.row=this.NewReportRow_2(m.QS.ReportTotal,this.ViewModel.GrpReportTotal.SubTotalAppearance),this.ViewModel.GrpReportTotal.Height>0&&(this.row.Height=this.ViewModel.GrpReportTotal.Height),this.row.LevelNo=0;let t=-1;for(this.k=0;this.k<this.ViewModel.ColumnSource.length;this.k++)this.ViewModel.GrpReportTotal.TotalCols.ContainsKey(this.oColumns[this.k].ID)&&(-1==t&&(t=this.k),this.row.Cells[this.k].CellAppearance.Alignment="Right",this.ViewModel.SetCellValue(this.lstTotal[0][this.k].toString(),this.oColumns[this.k].DataFormat,this.oColumns[this.k].ColumnType,this.row.Cells[this.k]));for(this.k=this.ViewModel.ColumnSource.length;this.k<this.oColumns.length;this.k++)-1==t&&(t=this.k),this.row.Cells[this.k].CellAppearance.Alignment="Right",this.ViewModel.SetCellValue(this.lstTotal[0][this.k].toString(),this.oColumns[this.k].DataFormat,this.oColumns[this.k].ColumnType,this.row.Cells[this.k]);this.row.Cells[0].Text=w.d.GetResource("Reports_ReportTotal"),t>0&&(this.GrdRow++,this.row.Cells[0].ColSpan=t,this.ViewModel.addRow(this.row))}addProductWiseAgeingRow(){if(this.oRow=this.NewReportRow(),this.oRow.Height=this.ViewModel.RowHeight,this.ShowLevelTree&&(this.oRow.LevelNo=parseInt(this.drMain.Depth)-1,this.oRow.Cells[1].IsNormal=!1,this.oRow.IsGroup=(0,y.yG0)(this.drMain.IsGroup),this.oRow.Cells[1].level=this.oRow.LevelNo,this.UpdateTreeTotals(this.oRow.LevelNo),this.lstParents.length>0&&(this.oRow.Parent=this.lstParents[this.lstParents.length-1]),(0,y.yG0)(this.drMain.IsGroup))){this.lstParents.push(this.oRow),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.oRow.Type=m.QS.BalanceBF;for(let t=0;t<this.oRow.Cells.length;t++)this.oRow.Cells[t].IsNormal=!1,this.oRow.Cells[t].CellAppearance=this.oColumns[t].DataAppearance.Clone(),this.oRow.Cells[t].CellAppearance.ForeColor=this.BalanceBFAppearance.ForeColor}if(!this.oRow.IsGroup){this.dbl=0;for(let t=0;t<=this.iSlabs.length;t++)this.dblS[t]=parseFloat(this.drMain["S"+t]),this.dbl+=this.dblS[t];this.dblIssue=parseFloat(this.drMain.Issue),this.dbl=this.dbl-this.dblIssue,this.drMain.BalQty=this.dbl;for(let t=this.iSlabs.length;t>=0;t--){if(this.dbl=parseFloat(this.drMain["S"+t]),this.dblIssue=this.dblIssue-this.dbl,!(this.dblIssue>=0)){this.drMain["S"+t]=-this.dblIssue;break}0==t&&this.dblIssue>0?this.drMain.S0=-this.dblIssue:this.drMain["S"+t]=0}if(null!=this.SlabValue){this.dblAvgRate=parseFloat(this.drMain.AvgRate);for(let t=0;t<=this.iSlabs.length;t++)this.drMain["SV"+t]=this.dblAvgRate*parseFloat(this.drMain["S"+t])}}this.oRow.NodeID=parseInt(this.drMain.ProductID);for(let t=0;t<this.oColumns.length;t++)this.CellValue=null,d.J0.IsEmpty(this.drMain[this.oColumns[t].ID])||(this.CellValue=this.drMain[this.oColumns[t].ID]),null!=this.CellValue&&(this.ViewModel.SetCellValue(this.CellValue,this.oColumns[t].DataFormat,this.oColumns[t].ColumnType,this.oRow.Cells[t]),d.J0.IsNum(this.CellValue)&&(this.dbl=d.J0.Double(this.CellValue),this.lstTotal.length>0&&(this.lstTotal[this.lstTotal.length-1][t]+=this.dbl),this.ViewModel.totals[t][this.ViewModel.lstGroup.length]+=this.dbl));this.oRow.LevelNo<=this.LevelNo&&(this.oRow.IsGroup||this.ViewModel.ApplyKPI(this.oRow),this.GrdRow++,this.ViewModel.addRow(this.oRow))}addProductWiseAgeing(){let t;for(this.lstParents.Clear(),this.lstTotal.Clear(),this.lstParents.push(this.NewReportRow()),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.k=0;this.k<this.dv.length;this.k++){if(this.oRow=this.NewReportRow(),this.oRow.Height=this.ViewModel.RowHeight,this.ShowLevelTree&&(this.oRow.LevelNo=parseInt(this.dv[this.k].Depth)-1,this.oRow.Cells[1].IsNormal=!1,this.oRow.IsGroup=(0,y.yG0)(this.dv[this.k].IsGroup),this.oRow.Cells[1].level=this.oRow.LevelNo,this.UpdateTreeTotals(this.oRow.LevelNo),(0,y.yG0)(this.dv[this.k].IsGroup))){this.lstParents.push(this.oRow),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.oRow.Type=m.QS.BalanceBF;for(let e=0;e<this.oRow.Cells.length;e++)this.oRow.Cells[e].IsNormal=!1,this.oRow.Cells[e].CellAppearance=this.oColumns[e].DataAppearance.Clone(),this.oRow.Cells[e].CellAppearance.ForeColor=this.BalanceBFAppearance.ForeColor}if(this.oRow.IsGroup||!(parseFloat(this.dv[this.k].BalQty)<0)){this.oRow.NodeID=parseInt(this.dv[this.k].ProductID);for(let e=0;e<this.oColumns.length;e++)this.CellValue=null,d.J0.IsEmpty(this.dv[this.k][this.oColumns[e].ID])||(this.CellValue=this.dv[this.k][this.oColumns[e].ID]),null!=this.CellValue&&(this.ViewModel.SetCellValue(this.CellValue,this.oColumns[e].DataFormat,this.oColumns[e].ColumnType,this.oRow.Cells[e]),d.J0.IsNum(this.CellValue)&&(t=d.J0.Double(this.CellValue),this.lstTotal.length>0&&(this.lstTotal[this.lstTotal.length-1][e]+=t),this.ViewModel.totals[e][this.ViewModel.lstGroup.length]+=t));this.oRow.LevelNo<=this.LevelNo&&(this.oRow.IsGroup||this.ViewModel.ApplyKPI(this.oRow),this.GrdRow++,this.ViewModel.addRow(this.oRow))}}this.ShowLevelTree&&this.UpdateTreeTotals(0),this.ViewModel.CheckAndAddTotals(this.dv)}addProductWiseExpiryAgeing(){let t;for(this.lstParents.Clear(),this.lstTotal.Clear(),this.lstParents.push(this.NewReportRow()),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.k=0;this.k<this.dv.length;this.k++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);if(this.oRow=this.NewReportRow(),this.oRow.Height=this.ViewModel.RowHeight,this.ShowLevelTree&&(this.oRow.LevelNo=parseInt(this.dv[this.k].Depth)-1,this.oRow.Cells[1].IsNormal=!1,this.oRow.IsGroup=(0,y.yG0)(this.dv[this.k].IsGroup),this.oRow.Cells[1].level=this.oRow.LevelNo,this.UpdateTreeTotals(this.oRow.LevelNo),(0,y.yG0)(this.dv[this.k].IsGroup))){this.lstParents.push(this.oRow),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.oRow.Type=m.QS.BalanceBF;for(let e=0;e<this.oRow.Cells.length;e++)this.oRow.Cells[e].IsNormal=!1,this.oRow.Cells[e].CellAppearance=this.oColumns[e].DataAppearance.Clone(),this.oRow.Cells[e].CellAppearance.ForeColor=this.BalanceBFAppearance.ForeColor}this.oRow.NodeID=parseInt(this.dv[this.k].ProductID);for(let e=0;e<this.oColumns.length;e++)this.CellValue=null,d.J0.IsEmpty(this.dv[this.k][this.oColumns[e].ID])||(this.CellValue=this.dv[this.k][this.oColumns[e].ID]),null!=this.CellValue&&(this.ViewModel.SetCellValue(this.CellValue,this.oColumns[e].DataFormat,this.oColumns[e].ColumnType,this.oRow.Cells[e]),d.J0.IsNum(this.CellValue)&&(t=d.J0.Double(this.CellValue),this.lstTotal.length>0&&(this.lstTotal[this.lstTotal.length-1][e]+=t)));this.oRow.LevelNo<=this.LevelNo&&(this.oRow.IsGroup||this.ViewModel.ApplyKPI(this.oRow),this.GrdRow++,this.ViewModel.addRow(this.oRow))}if(null!=this.SlabPercent&&(this.dblQty=0,this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("Quantity")&&(this.dblQty=this.lstTotal[0][this.ViewModel.GrpReportTotal.TotalCols.Quantity]),this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("Expired")&&(this.dblQty=this.dblQty-this.lstTotal[0][this.ViewModel.GrpReportTotal.TotalCols.Expired]),0!=this.dblQty))for(let e=0;e<=this.Slabs.length;e++)this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("S"+e)&&(t=this.lstTotal[0][this.ViewModel.GrpReportTotal.TotalCols["S"+e]],t=100*t/this.dblQty,this.lstTotal[0][this.ViewModel.GrpReportTotal.TotalCols["S"+e]+1]=t);this.AddReportTotals()}UpdateTreeTotals(t){for(let e=this.lstTotal.length-1;e>t;e--){if(e>0)for(let s=0;s<this.lstTotal[e].length;s++)this.lstTotal[e-1][s]+=this.lstTotal[e][s];for(let s=0;s<this.oColumns.length;s++)"FLOAT"==this.oColumns[s].ColumnType&&this.ViewModel.SetCellValue(this.lstTotal[e][s],this.oColumns[s].DataFormat,"FLOAT",this.lstParents[e].Cells[s]);if(t<=this.LevelNo){let s=this.ViewModel.Data.indexOf(this.lstParents[e]);s>=0&&(this.ViewModel.Data.Remove(this.lstParents[e]),this.ViewModel.Data.Insert(s,this.lstParents[e]))}this.lstParents.RemoveAt(e),this.lstTotal.RemoveAt(e)}}AddProductWiseBatchWiseAgeing(){let t,e,s;for(this.k=0;this.k<this.dv.length;this.k++){this.oRow=this.NewReportRow(),this.oRow.LevelNo=this.ViewModel.lstGroup.length,this.ViewModel.AddGroupRows(this.dv,this.k),this.dv[this.k].Expired=null;for(let i=0;i<=this.Slabs.length;i++)this.dv[this.k]["S"+i]=null;if(null==this.dv[this.k].ExpDate&&(this.dv[this.k].ExpDate=this.ViewModel.oReportDialog.ToDate.Date),s=d.J0.ParseDate(this.dv[this.k].ExpDate),s<this.ViewModel.oReportDialog.ToDate.Date)this.dv[this.k].Expired=this.dv[this.k].Quantity;else{for(t=0;t<this.Slabs.length&&!(s<this.Slabs[t]);t++);t>=0?this.dv[this.k]["S"+t]=this.dv[this.k].Quantity:this.dv[this.k].S0=this.dv[this.k].Quantity}for(let i=0;i<this.oColumns.length;i++)this.CellValue=null,d.J0.IsEmpty(this.dv[this.k][this.oColumns[i].ID])||(this.CellValue=this.dv[this.k][this.oColumns[i].ID]),null!=this.CellValue&&(this.ViewModel.SetCellValue(this.CellValue,this.oColumns[i].DataFormat,this.oColumns[i].ColumnType,this.oRow.Cells[i]),d.J0.IsNum(this.CellValue)&&(e=d.J0.Double(this.CellValue),this.ViewModel.totals[i][this.ViewModel.lstGroup.length]+=e));this.ViewModel.ApplyKPI(this.oRow),this.ViewModel.addRow(this.oRow)}this.ViewModel.CheckAndAddTotals(this.dv)}AddProductWiseSubstitues(t){let e=0;if(null==this.dtProducts){let o,i=this.dsMain.Tables[1];this.dtProducts=this.dv.ToTable(!0,["ProductID"]),this.dtProducts.forEach(h=>{this.dv=this.dvTable.filter(r=>r.SProductID==h.ProductID),this.dv.length>0&&(h.QOH=this.dv[0].QOH,i=this.dsMain.Tables[1].filter(r=>r.ProductID==h.ProductID),i.length>0?(o="",i.forEach(r=>{o.length>0&&(o+=", "),o+=r.SubstituteGroupName.toString()}),h.Product=this.dv[0].SName.toString()+" ("+o+")"):h.Product=this.dv[0].SName)})}let s=this.dtProducts.Copy();s.SortBy(["Product"]),this.dv.SortBy(["SName"]),d.J0.IsEmpty(t)||(t=" and "+t);for(let i=0;i<s.length;i++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);for(this.oRow=this.NewReportRow_2(m.QS.Group,this.ViewModel.lstGroup[0].GroupAppearance),this.ViewModel.lstGroup[0].Height>0&&(this.oRow.Height=this.ViewModel.lstGroup[0].Height),this.oRow.Cells[0].Text=s[i].Product.toString(),-1!=this.colQOHIndex?(this.oRow.Cells[0].ColSpan=this.colQOHIndex,this.ViewModel.SetCellValue(s[i].QOH.toString(),this.oColumns[this.colQOHIndex].DataFormat,this.oColumns[this.colQOHIndex].ColumnType,this.oRow.Cells[this.colQOHIndex]),this.oRow.Cells[this.colQOHIndex].CellAppearance.Alignment="Right"):this.oRow.Cells[0].ColSpan=this.dv.length,this.ViewModel.addRow(this.oRow),e=parseInt(s[i].ProductID),this.dv=this.dvTable.filter(o=>o.ProductID==e),this.k=0;this.k<this.dv.length;this.k++)if(parseInt(this.dv[this.k].SProductID)!=e){this.oRow=this.NewReportRow();for(let o=0;o<this.oColumns.length;o++)this.CellValue=null,d.J0.IsEmpty(this.dv[this.k][this.oColumns[o].ID])||(this.CellValue=this.dv[this.k][this.oColumns[o].ID]),null!=this.CellValue&&this.ViewModel.SetCellValue(this.CellValue,this.oColumns[o].DataFormat,this.oColumns[o].ColumnType,this.oRow.Cells[o]);this.ViewModel.ApplyKPI(this.oRow),this.ViewModel.addRow(this.oRow)}}}}}}]);