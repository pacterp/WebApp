"use strict";(self.webpackChunkRevenUWebApp=self.webpackChunkRevenUWebApp||[]).push([[7538],{75157:(A,S,n)=>{n.r(S),n.d(S,{PostDepreciationViewModel:()=>b});var l=n(32040),h=n(43767),C=n(26336),u=n(54581),p=n(33784),m=n(7321),g=n(82503),d=n(21774),P=n(85221),T=n(72247),D=n(27730),f=n(20643),I=n(23603),_=n(58170),y=n(88514);class b extends p.d{constructor(s,t,o){super(),this.FilterVisibility=!1,this.DateFilter="",this.FromDate=new g.Lc(0),this.AsonDate=new g.Lc(0),this.DateRanges=new D.y$(0),this.PostButtonLabel=null,this.Enable=!0,this.IsDashBoard=!1,this.IsUnPostScreen=!1,this.SystemDate=Date.Today(),this.IsPostingOnScheduleDate=!1,this.AllowEditPostingDate=!1,this.strSelect="",this.strJoin="",this.DateColIDs=new Array,this.Ddate=Date.Today(),this.SelectUnCheck=0,this.sbSchdulesDeleted="",this.iLoop=0,this.iStart=1,this.JVCCID=0,this.iFailure=0,this.dicVouchers=new C.bT,this.dicVouchersCnt=new C.bT,this.ClassName="PostDepreciationViewModel",this.IsDashBoard=t,this.DisplayName=this.Title=s,this.IsUnPostScreen=o,this.FromDate.Date=Date.Today().AddDays(1-Date.Today().getDate()),this.AsonDate.Date=this.FromDate.Date.AddMonths(1).AddDays(-1),this.DateRanges=new D.y$,this.DateRanges.Items=f.w.items_DateRanges,this.DateRanges.SelectionChangedCommand.Subscribe(this,"OnDateRangesSelectionChanged"),t?(this.FromDate.Width="190",this.AsonDate.Width="190",this.FromDate.LblWidth="72",this.AsonDate.LblWidth="80",window.innerWidth<=1540&&(this.FromDate.Width="",this.AsonDate.Width="",this.FromDate.LblWidth="",this.AsonDate.LblWidth="")):(this.FromDate.Width="150",this.AsonDate.Width="150"),this.PostButtonLabel=o?"Un-Post":l.d.GetResource("Post"),this.FromDate.Label=l.d.GetResource("FromDate"),this.AsonDate.Label=l.d.GetResource("ToDate");try{this.DepreciationGrid=new m.vv,this.DepreciationGrid.Width="",this.DepreciationGrid.Height=0,t||(this.DepreciationGrid.SearchVisible=!0,this.DepreciationGrid.SelectAll.Visible=!0,this.DepreciationGrid.SortVisible=!0,this.FilterVisibility=!0),this.DepreciationGrid.SelectAll.DBColumnName="select",this.InitColumns(),this.FilterVisibility?this.InitFilterScreen():this.DeprDataFilling()}catch(e){Logger.ErrorLog("PostDepreciationViewModel","Constructor",e)}}InitColumns(){let s=new Array,t=new d.O7;t.Header=l.d.GetResource("select"),t.DisplayMember="select",t.DataType="CheckBox",t.Width=55,t.CheckedChanged.Subscribe(this,"OnCheckedChanged"),s.push(t),this.IsUnPostScreen||(this.AllowEditPostingDate=l.d.SessionManager.IsActionAssigned(72,"Allow editing of depreciation posting date"),this.AllowEditPostingDate&&(t=new d.O7,t.Header="Post Date",t.DisplayMember="PostDate",t.DataType="DATE",t.Width=110,t.ReadOnly=!1,t.CheckedChanged.Subscribe(this,"OnCheckedChanged"),s.push(t)));let e,o=l.d.report.GetReportData(12,this.IsUnPostScreen?201:197,null),a=1,r="";o.Tables[0].forEach(i=>{e=new d.O7,e.Header="Asset Code"==i.Caption.toString()?l.d.GetResource("PDAssetCode"):"Asset Name"==i.Caption.toString()?l.d.GetResource("PDAssetName"):"Start Date"==i.Caption.toString()?l.d.GetResource("PDStartDate"):"End Date"==i.Caption.toString()?l.d.GetResource("PDEndDate"):"Depr Amount"==i.Caption.toString()?l.d.GetResource("PDDeprAmount"):"Accu. Depr"==i.Caption.toString()?l.d.GetResource("PDAccuDepr"):"Net Value"==i.Caption.toString()?l.d.GetResource("PDNetValue"):"Put To Use"==i.Caption.toString()?l.d.GetResource("PDPuttouse"):i.Caption.toString(),e.ID=i.ID.toString(),e.DisplayMember=i.ID.toString(),e.DataType=i.DType.toString(),"DATE"==e.DataType?(this.DateColIDs.push(e.DisplayMember),e.DisplayMember=e.DisplayMember+"_Key"):"FLOAT"==e.DataType?e.DecimalPoints=h.J0.IsNum(i.Decimals)?h.J0.Int(i.Decimals).toString():l.d.SessionManager.Preferences.DecimalsinAmount:"VoucherNo"==e.ID&&(e.DataType="LINK_VOUCHER"),e.ReadOnly=!0,e.Width=parseInt(i.Width),null!=i.Visible&&0==parseInt(i.Visible)&&(e.IsVisible=!1),s.push(e),33==e.ID.length&&(r="T"+a,"ACC_Assets"==i.SFSysTableName.toString()?null!=i.SSFIsFK&&(0,u.yG0)(i.SSFIsFK)?(this.strSelect+="DATE"==e.DataType?",convert(datetime,"+r+"."+i.SSFSysColumnName.toString()+") "+e.ID:","+r+"."+i.SSFSysColumnName.toString()+" "+e.ID,this.strJoin+=" left join "+i.SSFParentCostCenterSysName.toString()+" "+r+" with(nolock) on "+r+"."+i.SSFParentCostCenterColSysName.toString()+"=acc."+i.SFSysColumnName.toString()):this.strSelect+="DATE"==e.DataType?",convert(datetime,Acc."+i.SFSysColumnName.toString()+") "+e.ID:",Acc."+i.SFSysColumnName.toString()+" "+e.ID:"COM_CCCCDATA"==i.SFSysTableName.toString()&&null!=i.SSFIsFK&&(0,u.yG0)(i.SSFIsFK)&&(this.strSelect+="DATE"==e.DataType?",convert(datetime,"+r+"."+i.SSFSysColumnName.toString()+") "+e.ID:","+r+"."+i.SSFSysColumnName.toString()+" "+e.ID,this.strJoin+=" left join "+i.SSFParentCostCenterSysName.toString()+" "+r+" with(nolock) on "+r+"."+i.SSFParentCostCenterColSysName.toString()+"=cc."+i.SFSysColumnName.toString())),a++}),this.DepreciationGrid.Columns=s}DeprDataFilling(){if(this.deprTable=null,null==this.FromDate.Date||null==this.AsonDate.Date)return null==this.AsonDate.Date?this.DisplayMessage="Select "+this.AsonDate.Label:null==this.FromDate.Date&&(this.DisplayMessage="Select "+this.FromDate.Label),void(this.MessageVisibility=!0);let t,o,s={strTreeJoin:"",strTreeWhere:""};if(this.IsDashBoard||(this.DateFilter="From : "+this.FromDate.Date.ToString(l.d.SessionManager.Preferences["Date Format"]),this.DateFilter+="    To : "+this.AsonDate.Date.ToString(l.d.SessionManager.Preferences["Date Format"]),this.GetFilters(s)),this.SystemDate=Date.Today(),this.deprTable=I.Document.GetDepreciationDocuments(this.IsUnPostScreen,this.FromDate.Date,this.AsonDate.Date,this.strSelect,s.strTreeJoin+this.strJoin,s.strTreeWhere),null!=this.deprTable&&this.deprTable.Tables.length>0&&this.deprTable.Tables[0].length>0){this.deprTable.Columns[0].push("select"),this.AllowEditPostingDate&&(this.deprTable.Columns[0].push("PostDate_Key"),this.deprTable.Columns[0].push("PostDate"));let e=this.deprTable.Tables[1].filter(a=>"AssetDeprPostDate"==a.Name);e.length>0&&"ScheduleDate"==h.J0.String(e[0].Value)?this.IsPostingOnScheduleDate=!0:this.SystemDate=h.J0.ParseDate(this.deprTable.Tables[2][0].SystemDate),this.DateColIDs.forEach(a=>{this.deprTable.Columns[0].push(a+"_Key")}),this.deprTable.Tables[0].forEach(a=>{a.select=!1,this.DateColIDs.forEach(r=>{t=r+"_Key",h.J0.IsEmpty(a[r])||(o=h.J0.ParseDate(a[r]),a[t]=o.ToString(l.d.SessionManager.Preferences["Date Format"])),this.AllowEditPostingDate&&(this.IsPostingOnScheduleDate?(a.PostDate_Key=a.ToDate,a.PostDate=h.J0.ParseDate(a.ToDate).ToString(l.d.SessionManager.Preferences["Date Format"])):(a.PostDate_Key=this.SystemDate,a.PostDate=this.SystemDate.ToString(l.d.SessionManager.Preferences["Date Format"])))})})}this.DepreciationGrid.SelectAll.IsChecked=!1,this.DepreciationGrid.Table=this.deprTable.Tables[0],this.DepreciationGrid.setRowid()}OnButtonClick(s){"PostDepreciation"==s?this.IsUnPostScreen?this.worker_DoWork():(new P.N).DepreciationScheduleViewModel_2(this.deprTable,this):"RefreshDepr"==s?this.DeprDataFilling():"Regenerate"==s?this.FilterVisibility=!0:"DeprExport"==s||("FilterOK"==s?(this.DeprDataFilling(),this.FilterVisibility=!1):"FilterCancel"==s&&(this.FilterVisibility=!1))}SelectUnselectAll(s){for(let t=0;t<this.DepreciationGrid.Table.length;t++)0==this.SelectUnCheck&&(this.DepreciationGrid.Table[t].Select=s);this.SelectUnCheck=0}OnCheckedChanged(s,t){t||1==this.DepreciationGrid.SelectAll.IsChecked&&(this.SelectUnCheck=1,this.DepreciationGrid.SelectAll.IsChecked=!1)}worker_RunWorkerCompleted(){if(this.Enable=!0,this.sbSchdulesDeleted.length>0){let s;this.sbSchdulesDeleted.toString().split(",").forEach(o=>{s=this.DepreciationGrid.Table.filter(e=>e.ScheduleID==o),s.length>0&&this.DepreciationGrid.removeRow(s[0])})}}worker_DoWork(){this.Enable=!1;let s=this.DepreciationGrid.Table;if(this.drrPost=[],s.length>0&&(this.drrPost=s.filter(e=>1==e.select),this.drrPost.SortBy([{name:"ToDate",desc:!0},"VoucherNo"])),0==this.drrPost.length)return void(this.DisplayMessage=l.d.GetResource("PleaseSelectDepreciation"));this.DisplayMessage="Posting 0 of "+this.drrPost.length,this.sbSchdulesDeleted="",this.JVCCID=0;let o,t=this.deprTable.Tables[1].filter(e=>"DepreciationJV"==e.Name);t.length>0&&parseInt(t[0].Value)>0&&(this.JVCCID=parseInt(t[0].Value)),this.iFailure=0,this.dicVouchers.Clear(),this.dicVouchersCnt.Clear();for(let e=0;e<this.drrPost.length;e++)o=this.drrPost[e].VoucherNo.toString(),this.dicVouchers.ContainsKey(o)?(this.dicVouchers[o]+=","+this.drrPost[e].ScheduleID.toString(),this.dicVouchersCnt[o]++):(this.dicVouchers.push(o,this.drrPost[e].ScheduleID.toString()),this.dicVouchersCnt.push(o,1));this.iStart=1,this.iLoop=0,this.PostDepr_CallBack()}PostDepr_CallBack(){if(this.iLoop>=this.dicVouchers.keys.length)return void this.worker_RunWorkerCompleted();let s=this.dicVouchers.keys[this.iLoop];this.DisplayMessage=1==this.dicVouchersCnt[s]?"Posting "+this.iStart+" of "+this.drrPost.length:"Posting ("+this.iStart+"-"+(this.iStart+this.dicVouchersCnt[s]-1)+") of "+this.drrPost.length,y.V.SetsPostDeprReverseJV(this.JVCCID,s,this.dicVouchers[s]).then(t=>{this.DisplayMessage=t.Message,h.J0.Int(t.RetValue)>0?(this.sbSchdulesDeleted.length>0&&(this.sbSchdulesDeleted+=","),this.sbSchdulesDeleted+=this.dicVouchers[s]):this.iFailure+=this.dicVouchersCnt[s],this.iStart+=this.dicVouchersCnt[s],this.iLoop++,this.PostDepr_CallBack()})}InitFilterScreen(){this.tree=new Array,this.CostCenterFilters=new Array,this.CostCenters=new D.y$(0),this.CostCenters.Label=l.d.GetResource("SelectCostCenter"),this.CostCenters.SelectionChangedCommand.Subscribe(this,"OnCostCenterChange"),l.d.common.GetDataTable("ASS002",l.d.SessionManager.LanguageID).forEach(t=>{let o=parseInt(t.FeatureID);this.CostCenters.Items.push(D._p.ComboBoxItems_2(t.Name.toString(),t.FeatureID.toString())),72==o&&(this.CostCenters.SelectedValue="72",this.CostCenters.SelectedItem=this.CostCenters.Items[this.CostCenters.Items.length-1])}),this.LoadCostCenterTree(parseInt(this.CostCenters.SelectedValue),0,0,null)}OnCostCenterChange(s){if(!h.J0.IsEmpty(this.CostCenters.SelectedValue)&&(0==this.tree.length||this.tree[0].CostCenterID!=parseInt(this.CostCenters.SelectedValue))){let t=0;null!=this.CostCenters.SelectedItem&&!h.J0.IsEmpty(this.CostCenters.SelectedItem.Parent)&&(t=h.J0.Int(this.CostCenters.SelectedItem.Parent)),this.LoadCostCenterTree(parseInt(this.CostCenters.SelectedValue),t,0,null)}}LoadCostCenterTree(s,t,o,e){this.tree.Clear();let r,a="";if(50002==s&&"True"==l.d.SessionManager.Preferences.EnableLocationWise.toString()&&"True"==l.d.SessionManager.Preferences["LW Reports"]&&(a=h.J0.IsEmpty(l.d.SessionManager.LocationWhere)?"NodeID IN (-1234)":"NodeID IN ("+l.d.SessionManager.LocationWhere+")"),null==e)for(let i=0;i<this.CostCenterFilters.length;i++){let c=this.CostCenterFilters[i];if(c.CostCenterID==s&&c.LookupTypeID==t){e=c.SelectedNodes;break}}44==s&&t>0&&(a="A.LookupType="+t),r=new T.T,null==e?r.TreeViewModel_5(s,this,o,a,null):r.TreeViewModel_6(s,this,o,a,e,null),r.LookupTypeID=t,r.HeaderVisiblity=!1,r.OnNodeSelected=new _.Yk,r.OnNodeSelected.Subscribe(this,"OnNodeSelected"),this.tree.push(r)}GetFilters(s){s.strTreeJoin="",s.strTreeWhere="";let t="",o="";this.CostCenterFilters.forEach(e=>{if(o="",72==e.CostCenterID){for(let a=0;a<e.SelectedNodes.length;a++)(null==e.SelectedNodes[a].Parent||!e.SelectedNodes[a].Parent.IsSelected)&&(o.length>0&&(o+=","),o+=e.SelectedNodes[a].Id);o.length>0&&(s.strTreeJoin+=" join Acc_Assets GTP with(nolock) on Acc.lft between GTP.lft AND GTP.rgt",t+=" and GTP.AssetID in ("+o.toString()+")")}else{for(let a=0;a<e.SelectedNodes.length;a++)e.SelectedNodes[a].IsGroup||(o.length>0&&(o+=","),o+=e.SelectedNodes[a].Id);o.length>0&&(t+=50002==e.CostCenterID?" and (Acc.LocationID in ("+o.ToString()+") OR CC.CCNID"+(e.CostCenterID-5e4)+" in ("+o.ToString()+"))":" and CC.CCNID"+(e.CostCenterID-5e4)+" in ("+o.toString()+")")}}),s.strTreeWhere=t.toString()}OnDateRangesSelectionChanged(s){null!=this.DateRanges.SelectedValue&&f.w.SetDateRanges(this.DateRanges.SelectedValue,this.FromDate,this.AsonDate)}}}}]);